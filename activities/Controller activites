  public function import(Request $request)
    {
        $authCompany = Auth::guard('company')->user()->id;
        $companyId = searchCompanyId($authCompany);

        $additionalFeatures = fetchDataActivities($companyId, $request->project);
        $subscription = checkSubscriptionPermission($companyId, 'activities');

        // if (count($additionalFeatures) < $subscription->is_subscription) {
        try {
            $file = $request->file('file');
            $project = $request->project;
            $subproject = $request->subproject;
            $cacheKey = 'tmpcachekey';

            Cache::put($cacheKey, []);

            Excel::import(new ActivitesImport($project, $subproject, $companyId, $cacheKey), $file);
            $importedData = Cache::get($cacheKey);

            if (empty($importedData)) {
                return redirect()->route('company.activities.list')
                    ->with('success', 'Import Data Uploaded Successfully');
            } else {
                return redirect()->route('company.activities.nonImportData');
            }
        } catch (\Exception $e) {
            Log::error('Error importing Excel file: ' . $e->getMessage());

            return redirect()->back()
                ->with('error', 'Error importing Excel file');
        }
        // } else {
        //     return redirect()->back()
        //         ->with('expired', true);
        // }
    }






<?php

namespace App\Imports\Activites;

use Illuminate\Support\Str;
use App\Events\ExcelDataImported;
use App\Models\Company\Activities;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Event;
use Maatwebsite\Excel\Concerns\ToModel;
use Maatwebsite\Excel\Events\AfterSheet;
use Maatwebsite\Excel\Events\AfterImport;
use Maatwebsite\Excel\Events\BeforeImport;
use Maatwebsite\Excel\Concerns\ToCollection;
use Maatwebsite\Excel\Concerns\WithHeadingRow;

class ActivitesImport implements ToModel, WithHeadingRow
{
    protected $project;
    protected $subproject;
    protected $companyId;
    protected $tmpcachekey;

    public function __construct($project, $subproject, $companyId, $tmpcachekey)
    {
        $this->project = $project;
        $this->subproject = $subproject;
        $this->companyId = $companyId;
        $this->tmpcachekey = $tmpcachekey;
    }

    public function model(array $row)
    {
        Log::info('Excel import process started', $row);

        // dd(excelDateToDate($row['start_datedd_mm_yyyy']));
        // Null row checking
        if ($this->isNullRow($row)) {
            $this->cacheInvalidRow($row, 'Row is null or contains invalid data');
            return null;
        }

        // dd($row->collection());
        // Validate the row structure
        if (!$this->isValidSlNo($row)) {
            $this->cacheInvalidRow($row);
            return null;
        }

        $companyId = $this->companyId;
        $parentId = $this->calculateParentId($row['sl_no']);

        // Check if the same data already exists
        $existingActivity = Activities::where('project_id', $this->project)
            ->when($this->subproject, function ($query) {
                $query->where('subproject_id', $this->subproject);
            })
            ->where('activities', $row["activities"])   // Assuming 'id' is present in the row
            // ->oRwhere('uuid', $row["uuid"])   // Assuming 'id' is present in the row
            ->where('company_id', $companyId)
            ->first();

        if ($existingActivity) {
            $this->updateExistingActivity($existingActivity, $row);
            return null;
        }

        // Create new activity
        $data = new Activities([
            // 'uuid' => Str::uuid(),
            'project_id' => $this->project,
            'subproject_id' => $this->subproject,
            'type' => $parentId === null ? 'heading' : 'activity',
            'sl_no' => $row['sl_no'],
            'parent_id' => $parentId,
            'activities' => $row['activities'],
            'unit_id' => $this->getUnitId($row['units']),
            'qty' => $row['qty'],
            'rate' => $row['rate'],
            'amount' => $row['qty'] * $row['rate'],
            'start_date' => excelDateToDate($row['start_datedd_mm_yyyy']),
            'end_date' => excelDateToDate($row['end_datedd_mm_yyyy']),
            'company_id' => $companyId,
        ]);
        // dd($data);
        Log::info('************************Excel import process started Activities************************');
        Log::info($data);
        Log::info('************************End Excel import process started Activities************************');
        $this->logExportedData($data);
        return $data;
    }

    protected function isNullRow(array $row)
    {
        // Check if all required fields are null or empty
        $requiredFields = ['type', 'activities'];
        foreach ($requiredFields as $field) {
            if (!isset($row[$field]) || trim($row[$field]) === '') {
                return true;
            }
        }
        return false;
    }

    protected function isValidSlNo(array $row)
    {
        $slNoParts = explode('.', $row['sl_no']);
        $slNoCount = count($slNoParts);

        if ($slNoCount === 1 || $slNoCount === null) {
            return true;
        } elseif ($slNoCount === 2) {
            return $this->checkSlNo($slNoParts[0]);
        } elseif ($slNoCount === 3) {
            $slNoCombined = $slNoParts[0] . '.' . $slNoParts[1];
            return $this->checkSlNo($slNoCombined);
        }

        return false;
    }

    protected function calculateParentId($slNo)
    {
        $slNoParts = explode('.', $slNo);
        $slNoCount = count($slNoParts);

        if ($slNoCount === 1 || $slNoCount === null) {
            return null;
        } elseif ($slNoCount === 2) {
            return $this->getParentId($slNoParts[0]);
        } elseif ($slNoCount === 3) {
            $slNoCombined = $slNoParts[0] . '.' . $slNoParts[1];
            return $this->getParentId($slNoCombined);
        }
        return null;
    }

    protected function getParentId($slNoParts)
    {
        return Activities::where('sl_no', $slNoParts)
            ->where('company_id', $this->companyId)
            ->value('id'); // Directly fetch ID
    }

    protected function checkSlNo($slNoParts)
    {
        return Activities::where('sl_no', $slNoParts)
            ->where('company_id', $this->companyId)
            ->exists(); // Returns true/false
    }

    protected function getUnitId($unitName)
    {
        $unitId = nametoid($unitName, 'units');
        if ($unitId === false) {
            $unitId = createunit($unitName, $this->companyId);
        }
        return $unitId;
    }

    protected function updateExistingActivity($existingActivity, $row)
    {
        $shouldUpdate = (
            $existingActivity->unit_id !== $this->getUnitId($row['units']) ||
            $existingActivity->qty !== $row['qty'] ||
            $existingActivity->rate !== $row['rate'] ||
            $existingActivity->amount !== $row['qty'] * $row['rate']
        );

        // dd($shouldUpdate);
        if ($shouldUpdate) {
            $existingActivity->update([
                'activities' => $row['activities'],
                'unit_id' => $this->getUnitId($row['units']),
                'qty' => $row['qty'],
                'rate' => $row['rate'],
                'amount' => $row['qty'] * $row['rate'],
            ]);
        }
    }

    protected function cacheInvalidRow($row)
    {
        $invalidRows = Cache::get($this->tmpcachekey, []);
        $invalidRows[] = $row;
        Cache::put($this->tmpcachekey, $invalidRows);
    }

    protected function logExportedData($data)



**************************************************************************************************
**************************************************************************************************
**************************************************************************************************


**************************************************************************************************
**************************************************************************************************
<?php

namespace App\Exports\Activites;

use App\Models\Company\Assets;
use App\Models\Company\Activities;
use Illuminate\Support\Facades\Auth;
use Maatwebsite\Excel\Events\AfterSheet;
use App\Http\Resources\Export\ActivitesExportResources;
use Maatwebsite\Excel\Concerns\WithEvents;
use Maatwebsite\Excel\Concerns\WithHeadings;
use PhpOffice\PhpSpreadsheet\Cell\Coordinate;
use Maatwebsite\Excel\Concerns\FromCollection;
use Maatwebsite\Excel\Concerns\ShouldAutoSize;
use PhpOffice\PhpSpreadsheet\Cell\DataValidation;
use PhpOffice\PhpSpreadsheet\Style\Alignment;
use Maatwebsite\Excel\Concerns\WithMapping;
use PhpOffice\PhpSpreadsheet\Worksheet\Worksheet;


class ActivitesExport implements FromCollection, WithHeadings, ShouldAutoSize, WithEvents
{
    protected $projects;       // Selected project ID
    protected $subprojects;    // Selected subproject ID
    protected $units;          // Dropdown options for units
    protected $rowCount;       // Number of rows to apply formatting rules

    public function __construct($projects, $subprojects)
    {
        $this->projects = $projects;           // Assign selected project
        $this->subprojects = $subprojects;     // Assign selected subproject
        $this->units = getUnit();              // Fetch unit options dynamically
        $this->rowCount = 100;                 // Set maximum rows for the sheet
    }

    /**
     * Collect the data to be exported.
     */
    public function collection()
    {
        $authCompanyId = Auth::guard('company')->user()->id; // Get authenticated company user
        $companyId = searchCompanyId($authCompanyId);        // Search for the actual company ID

        $activities = Activities::with('units', 'project', 'subproject') // Fetch related models
            ->where('company_id', $companyId);

        // Filter by project if selected
        if (!empty($this->projects)) {
            $activities->where('project_id', $this->projects);

            // Further filter by subproject if selected
            if (!empty($this->subprojects)) {
                $activities->where('subproject_id', $this->subprojects);
            }
        }
        // dd($activities->get()->toArray());
        // Fetch the activities and add serial numbers (#) to the data
        $data = ActivitesExportResources::collection($activities->get());
        return collect($data->map(function ($item, $index) {
            $item['#'] = $index + 1; // Add serial number starting from 1
            return $item;
        }));
    }

    /**
     * Define the column headings for the export.
     */
    public function headings(): array
    {
        return [
            '#',          // A - Serial number
            'UUID',       // B - Hidden
            'Project',    // C - Hidden
            'Subproject', // D - Hidden
            'Type',       // E
            'SL No',      // F
            'Activities', // G
            'Units',      // H
            'Qty',        // I
            'Rate',       // J
            'Amount',     // K
            'Start Date(dd-mm-yyyy)', // L
            'End Date(dd-mm-yyyy)',   // M
            'Unit uuid',   // N-Hidden
        ];
    }

    /**
     * Register events for formatting and applying rules to the sheet.
     */
    public function registerEvents(): array
    {
        return [
            AfterSheet::class => function (AfterSheet $event) {
                // Hide columns B, C, and D
                $this->hideColumns($event, ['B', 'C', 'D', 'N']);

                // Apply dropdown validation for "Type" (E) and "Units" (H)
                $this->applyDropdownValidation($event, 'E', ['heading', 'activities']);
                $this->applyDropdownValidation($event, 'H', $this->units);

                // Apply formula for Amount (K = I * J)
                $this->applyCalculationFormula($event, 'K', 'I', 'J');

                // Apply date format for Start Date (L) and End Date (M)
                $this->applyDateFormat($event, 'L');
                $this->applyDateFormat($event, 'M');

                // Apply auto-sizing for all columns
                $this->autoSizeColumns($event, 13); // Total 13 columns
            },
        ];
    }

    /**
     * Hide specified columns.
     */
    private function hideColumns($event, $columns)
    {
        foreach ($columns as $column) {
            $event->sheet->getDelegate()->getColumnDimension($column)->setVisible(false);
        }
    }

    /**
     * Apply dropdown validation to a column.
     */
    private function applyDropdownValidation($event, $column, $options)
    {
        for ($row = 2; $row <= $this->rowCount; $row++) {
            $validation = $event->sheet->getCell("{$column}{$row}")->getDataValidation();
            $validation->setType(DataValidation::TYPE_LIST);
            $validation->setErrorStyle(DataValidation::STYLE_STOP);
            $validation->setAllowBlank(false);
            $validation->setShowDropDown(true);
            $validation->setFormula1(sprintf('"%s"', implode(',', $options)));
        }
    }

    /**
     * Apply calculation formula (e.g., K = I * J) to a column.
     */
    private function applyCalculationFormula($event, $resultColumn, $qtyColumn, $rateColumn)
    {
        for ($row = 2; $row <= $this->rowCount; $row++) {
            $qtyCell = "{$qtyColumn}{$row}";
            $rateCell = "{$rateColumn}{$row}";
            $resultCell = "{$resultColumn}{$row}";

            // Set the formula for the cell
            $event->sheet->getDelegate()
                ->setCellValue($resultCell, "={$qtyCell}*{$rateCell}");
        }
    }

    /**
     * Apply date format to a column.
     */
    private function applyDateFormat($event, $column)
    {
        for ($row = 2; $row <= $this->rowCount; $row++) {
            $cell = "{$column}{$row}";
            $event->sheet->getDelegate()->getStyle($cell)->getNumberFormat()
                ->setFormatCode('dd-mm-yyyy');
        }
    }

    /**
     * Auto-size all columns up to the given column count.
     */
    private function autoSizeColumns($event, $columnCount)
    {
        for ($i = 1; $i <= $columnCount; $i++) {
            $column = Coordinate::stringFromColumnIndex($i);
            $event->sheet->getColumnDimension($column)->setAutoSize(true);
        }
    }
}

**************************************************************************************************











    {
        Log::info('Exported Data:', $data->toArray());
    }
}

