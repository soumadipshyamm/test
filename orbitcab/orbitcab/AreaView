Larave'




@extends('layouts.app', [
    'isSidebar' => true,
    'isNavbar' => true,
    'isFooter' => false,
])

@push('styles')
    <style>
        #map {
            height: 600px;
            width: 100%;
            margin-top: 20px;
        }

        #geofence-form {
            margin-bottom: 20px;
        }

        #status {
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
@endpush

@section('content')
<div class="d-flex align-content-center flex-wrap gap-3">
    <x-site.back />
</div>
    <h2> Geofence ({{$cabZone->city->name}})</h2>
   {{-- {{$cabZone->city}} --}}
    <div id="map"></div>
    <div id="status"></div>
@endsection

@push('scripts')
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAVZ1qG4_OeMi2QisK6dwZYv7lsjMZF_BE&libraries=drawing,geometry"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let map, drawingManager, currentPolygon = null;
        let markers = [];
        let zonePolygons = [];
        const cityId = 1; // Replace with the actual city ID or dynamically fetch it

        document.addEventListener('DOMContentLoaded', function() {
            initMap({{ (float)$cabZone->city->latitude }}, {{ (float)$cabZone->city->longitude }});            // Fetch coordinates from the server
            drawPredefinedPolygon("{{$cabZone}}");
        });

        function initMap(lat, lng) {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: lat, lng: lng },
                zoom: 12,
                mapTypeId: 'roadmap'
            });

            // Add click listener to check if a point is inside the drawn polygon
            map.addListener("click", (e) => {
                if (!currentPolygon) {
                    document.getElementById("status").innerText = "Please draw the service area polygon first.";
                    document.getElementById("status").style.color = "orange";
                    return;
                }
                markers.forEach(m => m.setMap(null));
                markers = [];
                let marker = new google.maps.Marker({
                    position: e.latLng,
                    map,
                    title: "Test Point"
                });
                markers.push(marker);
                let inside = google.maps.geometry.poly.containsLocation(e.latLng, currentPolygon);
                document.getElementById("status").innerText = inside ?
                    "Location is INSIDE the service area." :
                    "Location is OUTSIDE the service area.";
                document.getElementById("status").style.color = inside ? "green" : "red";
            });
        }

        function drawPredefinedPolygon(coordinates) {
            console.log(coordinates);
            const predefinedCoordinates = {!! json_encode($cabZone->coordinates) !!};

            const polygon = new google.maps.Polygon({
                paths:predefinedCoordinates,
                strokeColor: '#4285F4',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#4285F4',
                fillOpacity: 0.25,
                map: map
            });

            zonePolygons.push(polygon);
            currentPolygon = polygon; // Set currentPolygon to the predefined polygon

            // Add mouseover and mouseout events for the polygon
            google.maps.event.addListener(polygon, 'mouseover', function() {
                this.setOptions({
                    strokeColor: '#FF0000', // Highlight color (red)
                    strokeWeight: 4,
                    fillOpacity: 0.35
                });
            });

            google.maps.event.addListener(polygon, 'mouseout', function() {
                this.setOptions({
                    strokeColor: '#4285F4',
                    strokeWeight: 2,
                    fillOpacity: 0.25
                });
            });
        }

        function startDrawing() {
            if (currentPolygon) currentPolygon.setMap(null);

            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['polygon'],
                },
                polygonOptions: {
                    fillColor: '#00FF00',
                    fillOpacity: 0.5,
                    strokeWeight: 2,
                    clickable: false,
                    editable: true,
                    zIndex: 2,
                },
            });
            drawingManager.setMap(map);
            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                if (currentPolygon) currentPolygon.setMap(null);
                currentPolygon = event.overlay;
                drawingManager.setMap(null);
                document.getElementById('save-geofence').style.display = 'block';
            });
        }

        function saveGeofence() {
            const areaName = prompt("Enter a name for this geofence:");
            if (areaName && currentPolygon) {
                const coords = currentPolygon.getPath().getArray().map(coord => ({
                    lat: coord.lat(),
                    lng: coord.lng()
                }));
                axios.post("{{ route('admin.cab-zones.store') }}", {
                    name: areaName,
                    coordinates: coords
                }).then(function(response) {
                    alert('Geofence "' + areaName + '" saved to database!');
                    currentPolygon.setMap(null);
                    document.getElementById('save-geofence').style.display = 'none';
                }).catch(function(error) {
                    alert('Failed to save geofence.');
                });
            } else {
                alert("Please draw a polygon first or provide a valid name.");
            }
        }
    </script>
@endpush

