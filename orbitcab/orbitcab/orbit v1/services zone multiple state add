@extends('layouts.app')

@section('content')
<div class="container">
  <button id="openModalBtn" class="btn btn-primary">Choose Country & States</button>

  <!-- Bootstrap Modal -->
  <div class="modal fade" id="locationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="locationForm" action="{{ route('locations.save') }}" method="POST">
        @csrf
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Select Country & States</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="country" class="form-label">Country</label>
              <select id="country" name="country_id" class="form-select" required>
                <option value="">-- Select country --</option>
                @foreach($countries as $country)
                  <option value="{{ $country->id }}">{{ $country->name }}</option>
                @endforeach
              </select>
            </div>

            <div class="mb-3">
              <label for="states" class="form-label">States (select multiple)</label>
              <select id="states" name="state_ids[]" class="form-select" multiple="multiple" style="width:100%" required>
                <!-- options injected by JS -->
              </select>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
@endsection

@section('scripts')
<!-- include jQuery, Bootstrap JS and optionally Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(function() {
  // init select2 on states for multi-select UX
  $('#states').select2({
    placeholder: 'Select states',
    width: 'resolve' // keeps style from css above
  });

  // open modal on click
  $('#openModalBtn').on('click', function() {
    var modal = new bootstrap.Modal(document.getElementById('locationModal'));
    modal.show();
  });

  // when country changes, fetch states
  $('#country').on('change', function() {
    var countryId = $(this).val();
    $('#states').empty().trigger('change'); // clear current options
    if (!countryId) return;

    $.ajax({
      url: '{{ url('') }}/states/' + countryId, // or use route('locations.states', ...)
      type: 'GET',
      success: function(states) {
        // states expected as [{id, name}, ...]
        states.forEach(function(s) {
          var option = new Option(s.name, s.id, false, false);
          $('#states').append(option);
        });
        $('#states').trigger('change');
      },
      error: function() {
        alert('Failed to load states for the selected country.');
      }
    });
  });

  // Optional: if you want to preselect values, you can set them here
  // $('#country').val(1).trigger('change'); then set states after AJAX completes
});
</script>
@endsection






namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\Country;
use App\Models\State;

class LocationController extends Controller
{
    // Return JSON states for given country id
    public function states($countryId)
    {
        $states = State::where('country_id', $countryId)->select('id', 'name')->get();
        return response()->json($states);
    }

    // Save the selection
    public function saveSelection(Request $request)
    {
        $data = $request->validate([
            'country_id' => 'required|exists:countries,id',
            'state_ids'  => 'required|array',
            'state_ids.*'=> 'exists:states,id'
        ]);

        // Example: attach to user or save in DB
        // auth()->user()->update(['country_id' => $data['country_id']]);
        // sync states depending on your model

        return redirect()->back()->with('success', 'Selection saved.');
    }
}




use App\Http\Controllers\LocationController;

Route::get('/states/{country}', [LocationController::class, 'states'])->name('locations.states');
Route::post('/save-selection', [LocationController::class, 'saveSelection'])->name('locations.save');
