
public function saveStates(Request $request)
{
    try {
        $serviceZoneUuid = $request->input('service_zone_uuid');
        $states = $request->input('states', []);
        $countryId = $request->input('country_id');
        
        // Validate input
        if (!is_array($states)) {
            return response()->json([
                'success' => false,
                'message' => 'States should be an array'
            ], 400);
        }
        
        // Find service zone city
        $serviceZone = ServiceZoneCity::where('uuid', $serviceZoneUuid)->first();
        
        if (!$serviceZone) {
            return response()->json([
                'success' => false,
                'message' => 'Service zone not found'
            ], 404);
        }
        
        // Find existing cab zone for this service zone
        $cabZone = CabZone::where('service_zone_cities_id', $serviceZone->id)
            ->where('country_id', $countryId)
            ->first();
        
        if (empty($states)) {
            // If no states selected, delete the record if exists
            if ($cabZone) {
                $cabZone->delete();
                return response()->json([
                    'success' => true,
                    'message' => 'All states removed for this country'
                ]);
            }
        } else {
            // Prepare states array - ensure they are integers
            $statesArray = array_map('intval', $states);
            
            if ($cabZone) {
                // Update existing record
                $cabZone->update([
                    'states_id' => json_encode($statesArray),
                    'updated_at' => now(),
                    'updated_by' => auth()->id()
                ]);
            } else {
                // Create new record
                CabZone::create([
                    'uuid' => Str::uuid(),
                    'service_zone_cities_id' => $serviceZone->id,
                    'country_id' => $countryId,
                    'states_id' => json_encode($statesArray),
                    'status' => 1,
                    'created_by' => auth()->id()
                ]);
            }
            
            // Get state names for response
            $stateNames = State::whereIn('id', $statesArray)
                ->pluck('name')
                ->toArray();
            
            return response()->json([
                'success' => true,
                'message' => count($statesArray) . ' state(s) saved successfully',
                'saved_states' => $statesArray,
                'state_names' => $stateNames
            ]);
        }
        
        return response()->json([
            'success' => true,
            'message' => 'Operation completed successfully'
        ]);
    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => $e->getMessage()
        ], 500);
    }
}

// Also update the getExistingStates function
public function getExistingStates(Request $request)
{
    try {
        $serviceZoneUuid = $request->input('service_zone_uuid');
        
        // Find existing states for this service zone from cab_zones table
        $existingCabZones = CabZone::where('service_zone_cities_id', function($query) use ($serviceZoneUuid) {
                $query->select('id')
                      ->from('service_zone_cities')
                      ->where('uuid', $serviceZoneUuid);
            })
            ->get();
        
        $existingStates = [];
        
        foreach ($existingCabZones as $cabZone) {
            // Decode the JSON array from states_id field
            $statesArray = json_decode($cabZone->states_id, true) ?: [];
            
            // Get state details
            if (!empty($statesArray)) {
                $states = State::whereIn('id', $statesArray)
                    ->get(['id', 'name', 'country_id']);
                
                foreach ($states as $state) {
                    $existingStates[] = [
                        'state_id' => $state->id,
                        'name' => $state->name,
                        'country_id' => $state->country_id
                    ];
                }
            }
        }
        
        return response()->json([
            'success' => true,
            'existing_states' => $existingStates
        ]);
    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => $e->getMessage()
        ], 500);
    }
}

// Update getStatesByCountry function
public function getStatesByCountry(Request $request)
{
    try {
        $countryId = $request->input('country_id');
        $serviceZoneUuid = $request->input('service_zone_uuid');
        
        // Get all states for the country
        $states = State::where('country_id', $countryId)
            ->orderBy('name')
            ->get(['id', 'name', 'country_id']);
        
        // Get existing states for this service zone and country
        $existingStateIds = [];
        if ($serviceZoneUuid) {
            $cabZone = CabZone::where('service_zone_cities_id', function($query) use ($serviceZoneUuid) {
                    $query->select('id')
                          ->from('service_zone_cities')
                          ->where('uuid', $serviceZoneUuid);
                })
                ->where('country_id', $countryId)
                ->first();
            
            if ($cabZone && $cabZone->states_id) {
                $existingStateIds = json_decode($cabZone->states_id, true) ?: [];
            }
        }

        return response()->json([
            'success' => true,
            'states' => $states,
            'existing_states' => $existingStateIds
        ]);
    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => $e->getMessage()
        ], 500);
    }
}





<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Factories\HasFactory;

class CabZone extends Model
{
    use HasFactory;

    protected $fillable = [
        'uuid',
        'service_zone_cities_id',
        'country_id',
        'states_id',
        'status',
        'created_by',
        'updated_by'
    ];

    // Cast states_id as array for automatic JSON encoding/decoding
    protected $casts = [
        'states_id' => 'array',
        'status' => 'boolean',
    ];

    // Relationships
    public function serviceZoneCity()
    {
        return $this->belongsTo(ServiceZoneCity::class, 'service_zone_cities_id');
    }

    public function country()
    {
        return $this->belongsTo(Country::class);
    }

    public function states()
    {
        // This is a custom relationship for the JSON array
        return State::whereIn('id', $this->states_id ?? [])->get();
    }

    public function createdBy()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    public function updatedBy()
    {
        return $this->belongsTo(User::class, 'updated_by');
    }
}





// Update the renderStatesCheckboxes function
function renderStatesCheckboxes() {
    let html = '';
    
    if (allStates.length === 0) {
        html = '<div class="alert alert-warning">No states found for this country.</div>';
    } else {
        // Get current country ID
        const currentCountryId = parseInt($('#countrySelect').val());
        
        // Find existing states for current country
        const existingStateIdsForCountry = existingStates
            .filter(state => state.country_id == currentCountryId)
            .map(state => state.state_id);
        
        console.log("Existing state IDs for country", currentCountryId, ":", existingStateIdsForCountry);
        
        // Create checkboxes
        allStates.forEach(state => {
            const isSelected = existingStateIdsForCountry.includes(state.id);
            
            html += `
                <div class="form-check">
                    <input type="checkbox" class="form-check-input state-checkbox" 
                           id="state_${state.id}" 
                           value="${state.id}"
                           ${isSelected ? 'checked' : ''}>
                    <label class="form-check-label" for="state_${state.id}">
                        ${state.name}
                        ${isSelected ? '<span class="badge badge-success ml-2">Already Added</span>' : ''}
                    </label>
                </div>
                <hr class="my-1">
            `;
        });
    }
    
    $('#stateCheckboxContainer').html(html);
    updateSelectedCount();
    
    // Add change event listener to checkboxes
    $('.state-checkbox').on('change', function() {
        updateSelectedCount();
    });
}

// Update the saveSelectedStates function
function saveSelectedStates() {
    const selectedStates = [];
    $('.state-checkbox:checked').each(function() {
        selectedStates.push(parseInt($(this).val()));
    });

    const countryId = parseInt($('#countrySelect').val());
    if (!countryId) {
        showError('Please select a country');
        return;
    }

    // Show loading state
    const saveButton = $('#saveStates');
    const originalText = saveButton.html();
    saveButton.html(`
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Saving...
    `).prop('disabled', true);

    $.ajax({
        url: '{{ route("admin.service-zones.save-states") }}',
        method: 'POST',
        data: {
            service_zone_uuid: serviceZoneId,
            country_id: countryId,
            states: selectedStates, // This will be sent as array
            _token: '{{ csrf_token() }}'
        },
        success: function(response) {
            if (response.success) {
                showSuccess(response.message || 'States saved successfully!');
                
                // Update existing states for this country
                // Remove existing states for this country
                existingStates = existingStates.filter(state => state.country_id !== countryId);
                
                // Add newly selected states
                selectedStates.forEach(stateId => {
                    existingStates.push({
                        state_id: stateId,
                        country_id: countryId
                    });
                });
                
                // Re-render checkboxes to update "Already Added" badges
                renderStatesCheckboxes();
                
                // Close modal after 2 seconds
                setTimeout(() => {
                    $('#addStateModal').modal('hide');
                    // Optional: Reload page or update table
                    location.reload();
                }, 2000);
            } else {
                showError(response.message || 'Failed to save states');
            }
        },
        error: function(xhr) {
            console.error('Error saving states:', xhr);
            showError('Error saving states. Please try again.');
        },
        complete: function() {
            saveButton.html(originalText).prop('disabled', false);
        }
    });
}
























function loadExistingStates(serviceZoneUuid) {
    $.ajax({
        url: '{{ route("admin.service-zones.get-existing-states") }}',
        method: 'GET',
        data: {
            service_zone_uuid: serviceZoneUuid,
            _token: '{{ csrf_token() }}'
        },
        success: function(response) {
            if (response.success) {
                // Flatten the array of states_id arrays into a single array
                existingStates = [];
                
                response.existing_states.forEach(function(stateGroup) {
                    if (stateGroup.states_id && Array.isArray(stateGroup.states_id)) {
                        // Convert string IDs to numbers and add to existingStates
                        stateGroup.states_id.forEach(function(stateId) {
                            existingStates.push({
                                state_id: parseInt(stateId),
                                name: stateGroup.name,
                                country_id: stateGroup.country_id
                            });
                        });
                    }
                });
                
                console.log("Processed existing states:", existingStates);
                
                // Set default country (India = 101) if no existing states
                let defaultCountryId = 101;
                if (existingStates.length > 0 && existingStates[0].country_id) {
                    defaultCountryId = existingStates[0].country_id;
                }
                
                // Set country select
                $('#countrySelect').val(defaultCountryId).trigger('change');
            } else {
                showError('Failed to load existing states');
            }
        },
        error: function(xhr) {
            console.error('Error loading existing states:', xhr);
            showError('Error loading existing states');
        }
    });
}

function renderStatesCheckboxes() {
    let html = '';
    
    if (allStates.length === 0) {
        html = '<div class="alert alert-warning">No states found for this country.</div>';
    } else {
        // Get current country ID
        const currentCountryId = $('#countrySelect').val();
        
        // Filter existing states for current country
        const existingStateIdsForCountry = existingStates
            .filter(state => state.country_id == currentCountryId)
            .map(state => state.state_id);
        
        console.log("Existing state IDs for country", currentCountryId, ":", existingStateIdsForCountry);
        
        // Create checkboxes
        allStates.forEach(state => {
            const isSelected = existingStateIdsForCountry.includes(state.id);
            
            html += `
                <div class="form-check">
                    <input type="checkbox" class="form-check-input state-checkbox" 
                           id="state_${state.id}" 
                           value="${state.id}"
                           ${isSelected ? 'checked' : ''}>
                    <label class="form-check-label" for="state_${state.id}">
                        ${state.name}
                        ${isSelected ? '<span class="badge badge-success ml-2">Already Added</span>' : ''}
                    </label>
                </div>
                <hr class="my-1">
            `;
        });
    }
    
    $('#stateCheckboxContainer').html(html);
    updateSelectedCount();
    
    // Add change event listener to checkboxes
    $('.state-checkbox').on('change', function() {
        updateSelectedCount();
    });
}

function saveSelectedStates() {
    const selectedStates = [];
    $('.state-checkbox:checked').each(function() {
        selectedStates.push(parseInt($(this).val()));
    });

    if (selectedStates.length === 0) {
        showError('Please select at least one state');
        return;
    }

    const countryId = parseInt($('#countrySelect').val());
    if (!countryId) {
        showError('Please select a country');
        return;
    }

    // Show loading state
    const saveButton = $('#saveStates');
    const originalText = saveButton.html();
    saveButton.html(`
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Saving...
    `).prop('disabled', true);

    $.ajax({
        url: '{{ route("admin.service-zones.save-states") }}',
        method: 'POST',
        data: {
            service_zone_uuid: serviceZoneId,
            country_id: countryId,
            states: selectedStates,
            _token: '{{ csrf_token() }}'
        },
        success: function(response) {
            if (response.success) {
                showSuccess(response.message || 'States saved successfully!');
                
                // Update existing states for this country
                // Remove existing states for this country first
                existingStates = existingStates.filter(state => state.country_id !== countryId);
                
                // Add newly selected states
                selectedStates.forEach(stateId => {
                    existingStates.push({
                        state_id: stateId,
                        country_id: countryId
                    });
                });
                
                // Re-render checkboxes to update "Already Added" badges
                renderStatesCheckboxes();
                
                // Close modal after 2 seconds
                setTimeout(() => {
                    $('#addStateModal').modal('hide');
                    // Optional: Reload page or update table
                    location.reload();
                }, 2000);
            } else {
                showError(response.message || 'Failed to save states');
            }
        },
        error: function(xhr) {
            console.error('Error saving states:', xhr);
            showError('Error saving states. Please try again.');
        },
        complete: function() {
            saveButton.html(originalText).prop('disabled', false);
        }
    });
}

// Also update the getStatesByCountry function
function getStatesByCountry(countryId) {
    $('#stateCheckboxContainer').html(`
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading states...</p>
        </div>
    `);

    $.ajax({
        url: '{{ route("admin.service-zones.get-states-by-country") }}',
        method: 'GET',
        data: {
            country_id: countryId,
            service_zone_uuid: serviceZoneId,
            _token: '{{ csrf_token() }}'
        },
        success: function(response) {
            if (response.success) {
                allStates = response.states || [];
                renderStatesCheckboxes();
            } else {
                $('#stateCheckboxContainer').html(`
                    <div class="alert alert-danger">
                        Failed to load states
                    </div>
                `);
            }
        },
        error: function(xhr) {
            console.error('Error loading states:', xhr);
            $('#stateCheckboxContainer').html(`
                <div class="alert alert-danger">
                    Error loading states. Please try again.
                </div>
            `);
        }
    });
}











public function getExistingStates(Request $request)
{
    try {
        $serviceZoneUuid = $request->input('service_zone_uuid');
        
        // Find existing states for this service zone from cab_zones table
        $existingStates = CabZone::where('service_zone_cities_id', function($query) use ($serviceZoneUuid) {
                $query->select('id')
                      ->from('service_zone_cities')
                      ->where('uuid', $serviceZoneUuid);
            })
            ->with(['state' => function($query) {
                $query->select('id', 'name', 'country_id');
            }])
            ->get()
            ->groupBy('country_id') // Group by country
            ->map(function($cabZones) {
                // Get first cab zone to get country info
                $firstCabZone = $cabZones->first();
                return [
                    'country_id' => $firstCabZone->country_id,
                    'name' => $firstCabZone->state->name ?? null,
                    'states_id' => $cabZones->pluck('states_id')->toArray()
                ];
            })
            ->values()
            ->toArray();

        return response()->json([
            'success' => true,
            'existing_states' => $existingStates
        ]);
    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => $e->getMessage()
        ], 500);
    }
}

public function getStatesByCountry(Request $request)
{
    try {
        $countryId = $request->input('country_id');
        $serviceZoneUuid = $request->input('service_zone_uuid');
        
        // Get all states for the country
        $states = State::where('country_id', $countryId)
            ->orderBy('name')
            ->get(['id', 'name', 'country_id']);
        
        // Get existing states for this service zone and country
        $existingStates = [];
        if ($serviceZoneUuid) {
            $existingStates = CabZone::where('service_zone_cities_id', function($query) use ($serviceZoneUuid) {
                    $query->select('id')
                          ->from('service_zone_cities')
                          ->where('uuid', $serviceZoneUuid);
                })
                ->where('country_id', $countryId)
                ->pluck('states_id')
                ->toArray();
        }

        return response()->json([
            'success' => true,
            'states' => $states,
            'existing_states' => $existingStates
        ]);
    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => $e->getMessage()
        ], 500);
    }
}

public function saveStates(Request $request)
{
    try {
        $serviceZoneUuid = $request->input('service_zone_uuid');
        $states = $request->input('states', []);
        $countryId = $request->input('country_id');
        
        // Validate input
        if (empty($states) || !is_array($states)) {
            return response()->json([
                'success' => false,
                'message' => 'No states provided'
            ], 400);
        }
        
        // Find service zone city
        $serviceZone = ServiceZoneCity::where('uuid', $serviceZoneUuid)->first();
        
        if (!$serviceZone) {
            return response()->json([
                'success' => false,
                'message' => 'Service zone not found'
            ], 404);
        }
        
        // Delete existing states for this service zone and country
        CabZone::where('service_zone_cities_id', $serviceZone->id)
            ->where('country_id', $countryId)
            ->delete();
        
        // Insert new states
        $insertData = [];
        foreach ($states as $stateId) {
            $insertData[] = [
                'uuid' => Str::uuid(),
                'service_zone_cities_id' => $serviceZone->id,
                'states_id' => $stateId,
                'country_id' => $countryId,
                'status' => 1,
                'created_by' => auth()->id(),
                'created_at' => now(),
                'updated_at' => now()
            ];
        }
        
        // Batch insert for better performance
        CabZone::insert($insertData);
        
        // Get state names for response
        $stateNames = State::whereIn('id', $states)
            ->pluck('name')
            ->toArray();
        
        return response()->json([
            'success' => true,
            'message' => count($states) . ' state(s) saved successfully',
            'saved_states' => $states,
            'state_names' => $stateNames
        ]);
    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => $e->getMessage()
        ], 500);
    }
}


{
    "success": true,
    "existing_states": [
        {
            "states_id": [
                "4032",
                "4033",
                "4034",
                "4035",
                "4036"
            ],
            "name": "Uttar Pradesh",
            "country_id": 101
        }
    ]
}



@extends('layouts.app', ['isSidebar' => true, 'isNavbar' => true, 'isFooter' => false])

@push('styles')
    <link rel="stylesheet" href="{{ asset('app-assets/vendors/css/forms/icheck/icheck.css') }}">
    <link rel="stylesheet" href="{{ asset('app-assets/vendors/css/forms/toggle/bootstrap-switch.min.css') }}">
    <link rel="stylesheet" href="{{ asset('app-assets/vendors/css/forms/toggle/switchery.min.css') }}">
    <link rel="stylesheet" href="{{ asset('app-assets/css/plugins/forms/switch.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/vendor/datatables/responsive.bootstrap4.min.css') }}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .state-checkbox-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
        .form-check-label {
            width: 100%;
            padding: 5px 0;
        }
        .badge {
            font-size: 0.75em;
            padding: 0.25em 0.6em;
        }
        .spinner-border {
            width: 1rem;
            height: 1rem;
        }
    </style>
@endpush

@section('content')
    <div class="content-header row top_header">
        <h4 class="py-2 mb-0"><span class="text-muted fw-light">{{ __('City Services Zone List') }}</span></h4>
        <div class="d-flex align-content-center flex-wrap gap-3">
            <a href="{{ route('admin.service-zones.create') }}" class="btn btn-primary">{{ __('Add Service City') }}</a>
        </div>
    </div>

    <div class="content-body">
        <section id="row-selection">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <a class="heading-elements-toggle"><i class="fa fa-ellipsis-v font-medium-3"></i></a>
                            <div class="heading-elements">
                                <ul class="list-inline mb-0">
                                    <li><a data-action="collapse"><i class="ft-minus"></i></a></li>
                                    <li><a data-action="reload"><i class="ft-rotate-cw"></i></a></li>
                                    <li><a data-action="expand"><i class="ft-maximize"></i></a></li>
                                    <li><a data-action="close"><i class="ft-x"></i></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-content collapse show">
                            <div class="card-body">
                                <table class="table table-striped table-bordered customdatatable" id="carTooable">
                                    <thead>
                                        <tr>
                                            <th>{{ __('Sr. No.') }}</th>
                                            <th>{{ __('State Name') }}</th>
                                            <th>{{ __('Service Area') }}</th>
                                            <th>{{ __('Action') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach ($zones as $key => $valu)
                                            <tr>
                                                <td>{{ $key + 1 }}</td>
                                                <input type="hidden" class="serviceZoneId" id="serviceZoneId"
                                                    value="{{ $valu?->uuid }}">
                                                @php
                                                    $cabezones = $valu?->cabZone->first();
                                                @endphp
                                                <td>
                                                    @if (isset($cabezones) && isset($cabezones->states_id) && $cabezones->states_id !== null)
                                                        {{ findState($cabezones->states_id, 'name') }}
                                                    @else
                                                        {{ $valu->state?->name }}
                                                    @endif
                                                    @if ($valu->status == 1 && $valu?->id !== null && $valu?->city?->id !== null)
                                                        @if (!$valu->cabZone->first())
                                                            <div class="text-right">
                                                                <a href="#" class="btn btn-sm btn-primary disabled"
                                                                    data-toggle="modal" data-target="#addStateModal">
                                                                    <i class="fas fa-plus-circle"></i>
                                                                </a>
                                                            </div>
                                                        @else
                                                            <div class="text-right">
                                                                <a href="#" class="btn btn-sm btn-primary addStateBtn"
                                                                    data-uuid="{{ $valu->uuid }}" data-toggle="modal"
                                                                    data-target="#addStateModal">
                                                                    <i class="fas fa-plus-circle"></i>
                                                                </a>
                                                            </div>
                                                        @endif
                                                    @else
                                                        <div class="text-right">
                                                            <a href="#" class="btn btn-sm btn-primary disabled"
                                                                data-toggle="modal" data-target="#addStateModal">
                                                                <i class="fas fa-plus-circle"></i>
                                                            </a>
                                                        </div>
                                                    @endif
                                                </td>
                                                <td>
                                                    @if ($valu->status == 1 && $valu?->id !== null && $valu?->city?->id !== null)
                                                        @if (!$valu->cabZone->first())
                                                            <a href="{{ route('admin.service-zones.editPolygonDraw', [$valu?->id, $valu?->city->id]) }}"
                                                                class="btn btn-primary">
                                                                <i class="fa-solid fa-draw-polygon"></i> Add Service Area
                                                            </a>
                                                        @endif
                                                        @if ($valu->cabZone->first())
                                                            <a href="{{ route('admin.service-zones.viewPolygonDraw', [$valu?->id, $valu?->city->id]) }}"
                                                                class="btn btn-secondary">
                                                                <i class="fa-solid fa-street-view"></i> View
                                                            </a>
                                                        @endif
                                                        @if ($valu->cabZone->first())
                                                            <a class="btn btn-danger deleteData"
                                                                data-uuid="{{ $valu->cabZone->first()->uuid }}"
                                                                href="javascript:void(0)" data-table="cab_zones">
                                                                <i class="fa-solid fa-trash"></i> Delete
                                                            </a>
                                                        @endif
                                                    @else
                                                        @if (!$valu->cabZone->first())
                                                            <button class="btn btn-secondary" disabled>
                                                                <i class="fa-solid fa-draw-polygon"></i> Add Service Area
                                                            </button>
                                                        @else
                                                            <button class="btn btn-secondary" disabled>
                                                                <i class="fa-solid fa-street-view"></i> View
                                                            </button>
                                                            <button class="btn btn-danger" disabled>
                                                                <i class="fa-solid fa-trash"></i> Delete
                                                            </button>
                                                        @endif
                                                    @endif
                                                </td>
                                                <td>
                                                    <div class="">
                                                        <label class="switch">
                                                            <input type="checkbox" class="changeStatus"
                                                                id="switchery_inline{{ $valu->uuid }}" name="is_active"
                                                                {{ $valu->status ? 'checked' : '' }}
                                                                data-uuid="{{ $valu->uuid }}"
                                                                data-table="service_zone_cities" data-message="deactive">
                                                            <span class="slider round"></span>
                                                        </label>
                                                        <a class="deleteData" href="javascript:void(0)"
                                                            data-table="service_zone_cities"
                                                            data-uuid="{{ $valu->uuid }}"> <span
                                                                style="margin-right: 5px;"><i
                                                                    class="fa-solid fa-trash"></i></span>Delete</a>
                                                    </div>
                                                </td>
                                            </tr>
                                        @endforeach
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Modal for Add State -->
    <div class="modal fade" id="addStateModal" tabindex="-1" role="dialog" aria-labelledby="addStateModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStateModalLabel">{{ __('Manage States for Service Zone') }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="selectedServiceZoneId" value="">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="countrySelect">{{ __('Select Country') }}</label>
                                <select id="countrySelect" class="form-control select2">
                                    <option value="">{{ __('Select Country') }}</option>
                                    @foreach ($countries as $country)
                                        <option value="{{ $country->id }}" {{ $country->id == 101 ? 'selected' : '' }}>
                                            {{ $country->name }}
                                        </option>
                                    @endforeach
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>{{ __('Selected States Count') }}</label>
                                <div class="alert alert-info mb-0" id="selectedCountInfo">
                                    0 states selected
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>{{ __('Available States') }}</label>
                        <div class="state-checkbox-container" id="stateCheckboxContainer">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Select a country to load states</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllBtn">
                                    <i class="fas fa-check-square"></i> Select All
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary ml-2" id="deselectAllBtn">
                                    <i class="fas fa-square"></i> Deselect All
                                </button>
                            </div>
                            <div id="stateStatusMessage"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ __('Close') }}</button>
                    <button type="button" class="btn btn-primary" id="saveStates">
                        <i class="fas fa-save"></i> {{ __('Save States') }}
                    </button>
                </div>
            </div>
        </div>
    </div>
@endsection

@push('scripts')
    <script src="{{ asset('app-assets/vendors/js/forms/icheck/icheck.min.js') }}"></script>
    <script src="{{ asset('app-assets/vendors/js/forms/toggle/bootstrap-switch.min.js') }}"></script>
    <script src="{{ asset('app-assets/vendors/js/forms/toggle/switchery.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/dataTables.bootstrap4.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/dataTables.responsive.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/responsive.bootstrap4.min.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.flash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{{ asset('assets/custom/js/datatableajax.js') }}"></script>

    <script>
        $(document).ready(function() {
            // Initialize Select2
            $('.select2').select2({
                width: '100%'
            });

            let serviceZoneId = null;
            let existingStates = [];
            let allStates = [];

            // Handle modal show event
            $('#addStateModal').on('show.bs.modal', function(event) {
                const button = $(event.relatedTarget);
                serviceZoneId = button.data('uuid');
                $('#selectedServiceZoneId').val(serviceZoneId);
                
                // Reset the modal
                resetModal();
                
                // Load existing states for this service zone
                if (serviceZoneId) {
                    loadExistingStates(serviceZoneId);
                }
            });

            // Handle country change
            $('#countrySelect').on('change', function() {
                const countryId = $(this).val();
                if (countryId && serviceZoneId) {
                    loadStatesForCountry(countryId);
                }
            });

            // Handle select all button
            $('#selectAllBtn').on('click', function() {
                $('.state-checkbox').prop('checked', true);
                updateSelectedCount();
            });

            // Handle deselect all button
            $('#deselectAllBtn').on('click', function() {
                $('.state-checkbox').prop('checked', false);
                updateSelectedCount();
            });

            // Handle save states button
            $('#saveStates').on('click', function() {
                saveSelectedStates();
            });

            // Handle modal hidden event
            $('#addStateModal').on('hidden.bs.modal', function() {
                serviceZoneId = null;
                existingStates = [];
                allStates = [];
                $('#selectedServiceZoneId').val('');
            });

            function resetModal() {
                $('#stateCheckboxContainer').html(`
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading states...</p>
                    </div>
                `);
                $('#selectedCountInfo').html('0 states selected');
                $('#stateStatusMessage').html('');
            }

            function loadExistingStates(serviceZoneUuid) {
                $.ajax({
                    url: '{{ route("admin.service-zones.get-existing-states") }}',
                    method: 'GET',
                    data: {
                        service_zone_uuid: serviceZoneUuid,
                        _token: '{{ csrf_token() }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            existingStates = response.existing_states || [];
                            
                            // Set default country (India = 101) if no existing states
                            let defaultCountryId = 101;
                            if (existingStates.length > 0 && existingStates[0].country_id) {
                                defaultCountryId = existingStates[0].country_id;
                            }
                            
                            // Set country select
                            $('#countrySelect').val(defaultCountryId).trigger('change');
                        } else {
                            showError('Failed to load existing states');
                        }
                    },
                    error: function(xhr) {
                        console.error('Error loading existing states:', xhr);
                        showError('Error loading existing states');
                    }
                });
            }

            function loadStatesForCountry(countryId) {
                $('#stateCheckboxContainer').html(`
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading states...</p>
                    </div>
                `);

                $.ajax({
                    url: '{{ route("admin.service-zones.get-states-by-country") }}',
                    method: 'GET',
                    data: {
                        country_id: countryId,
                        service_zone_uuid: serviceZoneId,
                        _token: '{{ csrf_token() }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            allStates = response.states || [];
                            renderStatesCheckboxes();
                        } else {
                            $('#stateCheckboxContainer').html(`
                                <div class="alert alert-danger">
                                    Failed to load states
                                </div>
                            `);
                        }
                    },
                    error: function(xhr) {
                        console.error('Error loading states:', xhr);
                        $('#stateCheckboxContainer').html(`
                            <div class="alert alert-danger">
                                Error loading states. Please try again.
                            </div>
                        `);
                    }
                });
            }

            function renderStatesCheckboxes() {
                let html = '';
                
                if (allStates.length === 0) {
                    html = '<div class="alert alert-warning">No states found for this country.</div>';
                } else {
                    allStates.forEach(state => {
                        const isSelected = existingStates.some(existing => 
                            existing.state_id == state.id || existing.id == state.id
                        );
                        
                        html += `
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input state-checkbox" 
                                       id="state_${state.id}" 
                                       value="${state.id}"
                                       ${isSelected ? 'checked' : ''}>
                                <label class="form-check-label" for="state_${state.id}">
                                    ${state.name}
                                    ${isSelected ? '<span class="badge badge-success ml-2">Already Added</span>' : ''}
                                </label>
                            </div>
                            <hr class="my-1">
                        `;
                    });
                }
                
                $('#stateCheckboxContainer').html(html);
                updateSelectedCount();
                
                // Add change event listener to checkboxes
                $('.state-checkbox').on('change', function() {
                    updateSelectedCount();
                });
            }

            function updateSelectedCount() {
                const selectedCount = $('.state-checkbox:checked').length;
                const totalCount = $('.state-checkbox').length;
                
                $('#selectedCountInfo').html(`
                    ${selectedCount} of ${totalCount} states selected
                `);
                
                // Update status message
                if (selectedCount === 0) {
                    $('#stateStatusMessage').html('<span class="text-danger">Please select at least one state</span>');
                } else {
                    $('#stateStatusMessage').html(`<span class="text-success">${selectedCount} states ready to save</span>`);
                }
            }

            function saveSelectedStates() {
                const selectedStates = [];
                $('.state-checkbox:checked').each(function() {
                    selectedStates.push($(this).val());
                });

                if (selectedStates.length === 0) {
                    showError('Please select at least one state');
                    return;
                }

                const countryId = $('#countrySelect').val();
                if (!countryId) {
                    showError('Please select a country');
                    return;
                }

                // Show loading state
                const saveButton = $('#saveStates');
                const originalText = saveButton.html();
                saveButton.html(`
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    Saving...
                `).prop('disabled', true);

                $.ajax({
                    url: '{{ route("admin.service-zones.save-states") }}',
                    method: 'POST',
                    data: {
                        service_zone_uuid: serviceZoneId,
                        country_id: countryId,
                        states: selectedStates,
                        _token: '{{ csrf_token() }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            showSuccess(response.message || 'States saved successfully!');
                            
                            // Update existing states
                            existingStates = response.updated_states || selectedStates.map(id => ({ state_id: id }));
                            
                            // Update UI to show "Already Added" badges
                            renderStatesCheckboxes();
                            
                            // Close modal after 2 seconds
                            setTimeout(() => {
                                $('#addStateModal').modal('hide');
                                // Optional: Reload page or update table
                                // location.reload();
                            }, 2000);
                        } else {
                            showError(response.message || 'Failed to save states');
                        }
                    },
                    error: function(xhr) {
                        console.error('Error saving states:', xhr);
                        showError('Error saving states. Please try again.');
                    },
                    complete: function() {
                        saveButton.html(originalText).prop('disabled', false);
                    }
                });
            }

            function showSuccess(message) {
                $('#stateStatusMessage').html(`
                    <div class="alert alert-success alert-dismissible fade show py-1" role="alert">
                        <i class="fas fa-check-circle"></i> ${message}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                `);
            }

            function showError(message) {
                $('#stateStatusMessage').html(`
                    <div class="alert alert-danger alert-dismissible fade show py-1" role="alert">
                        <i class="fas fa-exclamation-circle"></i> ${message}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                `);
            }
        });
    </script>
@endpush




// Add these routes to your web.php file
Route::prefix('admin')->middleware(['auth', 'admin'])->group(function () {
    // ... other routes ...
    
    Route::get('/service-zones/get-existing-states', [ServiceZoneController::class, 'getExistingStates'])
        ->name('admin.service-zones.get-existing-states');
    
    Route::get('/service-zones/get-states-by-country', [ServiceZoneController::class, 'getStatesByCountry'])
        ->name('admin.service-zones.get-states-by-country');
    
    Route::post('/service-zones/save-states', [ServiceZoneController::class, 'saveStates'])
        ->name('admin.service-zones.save-states');
});



// In your ServiceZoneController.php
use App\Models\CabZone;
use App\Models\State;
use Illuminate\Http\Request;

public function getExistingStates(Request $request)
{
    try {
        $serviceZoneUuid = $request->input('service_zone_uuid');
        
        // Find existing states for this service zone from cab_zones table
        $existingStates = CabZone::where('service_zone_cities_id', function($query) use ($serviceZoneUuid) {
                $query->select('id')
                      ->from('service_zone_cities')
                      ->where('uuid', $serviceZoneUuid);
            })
            ->with('state')
            ->get()
            ->map(function($cabZone) {
                return [
                    'state_id' => $cabZone->states_id,
                    'name' => $cabZone->state->name ?? null,
                    'country_id' => $cabZone->state->country_id ?? null
                ];
            });

        return response()->json([
            'success' => true,
            'existing_states' => $existingStates
        ]);
    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => $e->getMessage()
        ], 500);
    }
}

public function getStatesByCountry(Request $request)
{
    try {
        $countryId = $request->input('country_id');
        $serviceZoneUuid = $request->input('service_zone_uuid');
        
        // Get all states for the country
        $states = State::where('country_id', $countryId)
            ->orderBy('name')
            ->get(['id', 'name', 'country_id']);
        
        // Get existing states for this service zone
        $existingStates = [];
        if ($serviceZoneUuid) {
            $existingStates = CabZone::where('service_zone_cities_id', function($query) use ($serviceZoneUuid) {
                    $query->select('id')
                          ->from('service_zone_cities')
                          ->where('uuid', $serviceZoneUuid);
                })
                ->pluck('states_id')
                ->toArray();
        }

        return response()->json([
            'success' => true,
            'states' => $states,
            'existing_states' => $existingStates
        ]);
    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => $e->getMessage()
        ], 500);
    }
}

public function saveStates(Request $request)
{
    try {
        $serviceZoneUuid = $request->input('service_zone_uuid');
        $states = $request->input('states', []);
        $countryId = $request->input('country_id');
        
        // Find service zone city
        $serviceZone = ServiceZoneCity::where('uuid', $serviceZoneUuid)->first();
        
        if (!$serviceZone) {
            return response()->json([
                'success' => false,
                'message' => 'Service zone not found'
            ], 404);
        }
        
        // Delete existing states for this service zone
        CabZone::where('service_zone_cities_id', $serviceZone->id)->delete();
        
        // Insert new states
        foreach ($states as $stateId) {
            CabZone::create([
                'uuid' => Str::uuid(),
                'service_zone_cities_id' => $serviceZone->id,
                'states_id' => $stateId,
                'country_id' => $countryId,
                'status' => 1,
                'created_by' => auth()->id()
            ]);
        }
        
        return response()->json([
            'success' => true,
            'message' => 'States saved successfully',
            'updated_states' => $states
        ]);
    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => $e->getMessage()
        ], 500);
    }
}









@extends('layouts.app', ['isSidebar' => true, 'isNavbar' => true, 'isFooter' => false])

@push('styles')
    <link rel="stylesheet" href="{{ asset('app-assets/vendors/css/forms/icheck/icheck.css') }}">
    <link rel="stylesheet" href="{{ asset('app-assets/vendors/css/forms/toggle/bootstrap-switch.min.css') }}">
    <link rel="stylesheet" href="{{ asset('app-assets/vendors/css/forms/toggle/switchery.min.css') }}">
    <link rel="stylesheet" href="{{ asset('app-assets/css/plugins/forms/switch.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/vendor/datatables/responsive.bootstrap4.min.css') }}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
@endpush

@section('content')
    <div class="content-header row top_header">
        <h4 class="py-2 mb-0"><span class="text-muted fw-light">{{ __('City Services Zone List') }}</span></h4>
        <div class="d-flex align-content-center flex-wrap gap-3">
            <a href="{{ route('admin.service-zones.create') }}" class="btn btn-primary">{{ __('Add Service City') }}</a>
            {{-- <button class="btn btn-secondary" data-toggle="modal"
                data-target="#addStateModal">{{ __('Add State') }}</button> --}}
        </div>
    </div>

    <div class="content-body">
        <section id="row-selection">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <a class="heading-elements-toggle"><i class="fa fa-ellipsis-v font-medium-3"></i></a>
                            <div class="heading-elements">
                                <ul class="list-inline mb-0">
                                    <li><a data-action="collapse"><i class="ft-minus"></i></a></li>
                                    <li><a data-action="reload"><i class="ft-rotate-cw"></i></a></li>
                                    <li><a data-action="expand"><i class="ft-maximize"></i></a></li>
                                    <li><a data-action="close"><i class="ft-x"></i></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-content collapse show">
                            <div class="card-body">
                                <table class="table table-striped table-bordered customdatatable" id="carTooable">
                                    <thead>
                                        <tr>
                                            <th>{{ __('Sr. No.') }}</th>
                                            <th>{{ __('State Name') }}</th>
                                            <th>{{ __('Service Area') }}</th>
                                            <th>{{ __('Action') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach ($zones as $key => $valu)
                                            <tr>
                                                <td>{{ $key + 1 }}</td>
                                                <input type="hidden" class="serviceZoneId" id="serviceZoneId"
                                                    value="{{ $valu?->uuid }}">
                                                {{-- @dd($valu) --}}
                                                @php
                                                    $cabezones = $valu?->cabZone->first();
                                                @endphp
                                                <td>
                                                    @if (isset($cabezones) && isset($cabezones->states_id) && $cabezones->states_id !== null)
                                                        {{ findState($cabezones->states_id, 'name') }}
                                                    @else
                                                        {{ $valu->state?->name }}
                                                    @endif
                                                    @if ($valu->status == 1 && $valu?->id !== null && $valu?->city?->id !== null)
                                                        @if (!$valu->cabZone->first())
                                                            <div class="text-right">
                                                                <a href="#" class="btn btn-sm btn-primary disabled"
                                                                    data-toggle="modal" data-target="#addStateModal">
                                                                    <i class="fas fa-plus-circle"></i>
                                                                </a>
                                                            </div>
                                                        @else
                                                            <div class="text-right">
                                                                <a href="#" class="btn btn-sm btn-primary addStateBtn"
                                                                    {{-- data-toggle="modal" --}} data-uuid="{{ $valu->uuid }}">
                                                                    {{-- data-target="#addStateModal"> --}}
                                                                    <i class="fas fa-plus-circle"></i>
                                                                </a>
                                                            </div>
                                                        @endif
                                                    @else
                                                        <div class="text-right">
                                                            <a href="#" class="btn btn-sm btn-primary disabled"
                                                                data-toggle="modal" data-target="#addStateModal">
                                                                <i class="fas fa-plus-circle"></i>
                                                            </a>
                                                        </div>
                                                    @endif
                                                </td>
                                                <td>
                                                    @if ($valu->status == 1 && $valu?->id !== null && $valu?->city?->id !== null)
                                                        @if (!$valu->cabZone->first())
                                                            <a href="{{ route('admin.service-zones.editPolygonDraw', [$valu?->id, $valu?->city->id]) }}"
                                                                class="btn btn-primary">
                                                                <i class="fa-solid fa-draw-polygon"></i> Add Service Area
                                                            </a>
                                                        @endif
                                                        @if ($valu->cabZone->first())
                                                            <a href="{{ route('admin.service-zones.viewPolygonDraw', [$valu->id, $valu->city->id]) }}"
                                                                class="btn btn-secondary">
                                                                <i class="fa-solid fa-street-view"></i> View
                                                            </a>
                                                        @endif
                                                        @if ($valu->cabZone->first())
                                                            <a class="btn btn-danger deleteData"
                                                                data-uuid="{{ $valu->cabZone->first()->uuid }}"
                                                                href="javascript:void(0)" data-table="cab_zones">
                                                                <i class="fa-solid fa-trash"></i> Delete
                                                            </a>
                                                        @endif
                                                    @else
                                                        @if (!$valu->cabZone->first())
                                                            <button class="btn btn-secondary" disabled>
                                                                <i class="fa-solid fa-draw-polygon"></i> Add Service Area
                                                            </button>
                                                        @else
                                                            <button class="btn btn-secondary" disabled>
                                                                <i class="fa-solid fa-street-view"></i> View
                                                            </button>
                                                            <button class="btn btn-danger" disabled>
                                                                <i class="fa-solid fa-trash"></i> Delete
                                                            </button>
                                                        @endif
                                                    @endif
                                                </td>
                                                <td>
                                                    <div class="">
                                                        <label class="switch">
                                                            <input type="checkbox" class="changeStatus"
                                                                id="switchery_inline{{ $valu->uuid }}" name="is_active"
                                                                {{ $valu->status ? 'checked' : '' }}
                                                                data-uuid="{{ $valu->uuid }}"
                                                                data-table="service_zone_cities" data-message="deactive">
                                                            <span class="slider round"></span>
                                                        </label>
                                                        <a class="deleteData" href="javascript:void(0)"
                                                            data-table="service_zone_cities"
                                                            data-uuid="{{ $valu->uuid }}"> <span
                                                                style="margin-right: 5px;"><i
                                                                    class="fa-solid fa-trash"></i></span>Delete</a>
                                                    </div>
                                                </td>
                                            </tr>
                                        @endforeach
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
        </section>
    </div>

    <!-- Modal for Add State -->
    <div class="modal fade" id="addStateModal" tabindex="-1" role="dialog" aria-labelledby="addStateModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStateModalLabel">{{ __('Add State') }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="selectedCountryId" value="">
                    <div class="form-group">
                        <label for="countrySelect">{{ __('Select Country') }}</label>
                        <select id="countrySelect" class="form-control">
                            <option value="">{{ __('Select Country') }}</option>
                            @foreach ($countries as $country)
                                <option value="{{ $country->id }}" {{ $country->id == 101 ? 'selected' : '' }}>
                                    {{ $country->name }}
                                </option>
                            @endforeach
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="stateSelect">{{ __('Select States') }}</label>
                        <select id="stateSelect" class="form-control" multiple>
                            <!-- States will be populated based on selected country -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ __('Close') }}</button>
                    <button type="button" class="btn btn-primary" id="saveStates">{{ __('Save States') }}</button>
                </div>
            </div>
        </div>
    </div>
@endsection

@push('scripts')
    <script src="{{ asset('app-assets/vendors/js/forms/icheck/icheck.min.js') }}"></script>
    <script src="{{ asset('app-assets/vendors/js/forms/toggle/bootstrap-switch.min.js') }}"></script>
    <script src="{{ asset('app-assets/vendors/js/forms/toggle/switchery.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/dataTables.bootstrap4.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/dataTables.responsive.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/responsive.bootstrap4.min.js') }}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Load Bootstrap JS (important for modal functions) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.flash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{{ asset('assets/custom/js/datatableajax.js') }}"></script>


    <script>
        $(document).ready(function() {
            // Define baseUrl if not already defined
            var baseUrl = window.location.origin + '/';

            // Store existing states for current service zone
            var existingStates = [];

            // Handle "Add State" button click
            $('.addStateBtn').on('click', function(event) {
                event.preventDefault();

                // Get the data-uuid from the clicked button
                const serviceZoneUuid = $(this).attr('data-uuid');

                // Set the uuid in the hidden input field
                $('#selectedCountryId').val(serviceZoneUuid);

                console.log("Service Zone UUID set:", serviceZoneUuid);

                // Clear previous data
                existingStates = [];
                resetAddStateModal();

                // First, load existing states for this service zone
                loadExistingStates(serviceZoneUuid);
            });

            // Handle country dropdown change
            $('#countrySelect').change(function() {
                var countryId = $(this).val();
                var serviceZoneUuid = $('#selectedCountryId').val();

                if (countryId && serviceZoneUuid) {
                    loadStatesForCountry(countryId, serviceZoneUuid);
                }
            });

            // Handle "Save States" button click
            $('#saveStates').click(function() {
                saveSelectedStates();
            });

            // Clear modal when it's hidden
            $('#addStateModal').on('hidden.bs.modal', function() {
                clearAddStateModal();
            });
        });

        function resetAddStateModal() {
            // Clear all state checkboxes
            $('#stateSelect').empty();

            // Reset any error messages if present
            $('.state-error').remove();

            // Show loading indicator
            $('#stateSelect').html(
                '<div class="text-center py-4">' +
                '<div class="spinner-border text-primary" role="status">' +
                '<span class="visually-hidden">Loading...</span>' +
                '</div>' +
                '<p class="mt-2">Loading states...</p>' +
                '</div>'
            );
        }

        function loadExistingStates(serviceZoneUuid) {
            if (!serviceZoneUuid) {
                console.error("No service zone UUID provided");
                return;
            }

            $.ajax({
                url: baseUrl + 'ajax/get-existing-states/',
                method: 'GET',
                data: {
                    _token: '{{ csrf_token() }}',
                    service_zone_uuid: serviceZoneUuid
                }
                function success(data) {
                    console.log("Existing states loaded:", data);

                    if (data && data.existingStates) {
                        // Store existing states
                        existingStates = data.existingStates;

                        // Determine which country to show based on existing states
                        let defaultCountryId = 101; // Default to India

                        if (data.existingStates.length > 0 && data.existingStates[0].country_id) {
                            // Use the country from first existing state
                            defaultCountryId = data.existingStates[0].country_id;
                        }

                        // Set country dropdown
                        $('#countrySelect').val(defaultCountryId).trigger('change');

                        // Show modal
                        $('#addStateModal').modal('show');
                    } else {
                        // No existing states, show default country
                        $('#countrySelect').val(101).trigger('change');
                        $('#addStateModal').modal('show');
                    }
                },
                error: function(xhr) {
                    console.error("Error loading existing states:", xhr.responseText);
                    // Fallback to default country
                    $('#countrySelect').val(101).trigger('change');
                    $('#addStateModal').modal('show');
                }
            });
        }

        function loadStatesForCountry(countryId, serviceZoneUuid) {
            var stateCheckboxes = $('#stateSelect');

            if (!countryId) {
                stateCheckboxes.html('<div class="alert alert-warning state-error">Please select a country first.</div>');
                return;
            }

            // Show loading indicator
            stateCheckboxes.html(
                '<div class="text-center py-3">' +
                '<div class="spinner-border spinner-border-sm text-primary" role="status">' +
                '<span class="visually-hidden">Loading...</span>' +
                '</div>' +
                '<span class="ms-2">Loading states...</span>' +
                '</div>'
            );

            $.ajax({
                url: baseUrl + 'ajax/states/' + countryId,
                method: 'GET',
                success: function(data) {
                    stateCheckboxes.empty();

                    if (data.length > 0) {
                        // Get existing state IDs for this service zone in this country
                        let existingStateIds = [];
                        if (existingStates.length > 0) {
                            existingStateIds = existingStates
                                .filter(state => state.country_id == countryId)
                                .map(state => state.state_id || state.id);
                        }

                        // Check if any states exist for this country in the database
                        let hasExistingStatesInCountry = existingStateIds.length > 0;

                        if (hasExistingStatesInCountry) {
                            // Show info about existing states
                            stateCheckboxes.append(
                                '<div class="alert alert-info mb-3">' +
                                '<i class="bi bi-info-circle"></i> ' +
                                existingStateIds.length + ' state(s) already added for this country.' +
                                '</div>'
                            );
                        }

                        // Create checkboxes for all states in this country
                        $.each(data, function(index, state) {
                            let isChecked = existingStateIds.includes(state.id);

                            stateCheckboxes.append(
                                '<div class="form-check mb-2">' +
                                '<input class="form-check-input state-checkbox" type="checkbox" value="' +
                                state.id + '" id="state' + state.id + '" ' +
                                (isChecked ? 'checked' : '') + '>' +
                                '<label class="form-check-label" for="state' +
                                state.id + '">' + state.name +
                                (isChecked ? ' <span class="badge bg-success">Added</span>' : '') +
                                '</label>' +
                                '</div>'
                            );
                        });

                        // Add select all/none options if there are many states
                        if (data.length > 5) {
                            stateCheckboxes.prepend(
                                '<div class="mb-3">' +
                                '<button type="button" class="btn btn-sm btn-outline-primary me-2 select-all-btn">Select All</button>' +
                                '<button type="button" class="btn btn-sm btn-outline-secondary select-none-btn">Select None</button>' +
                                '</div>'
                            );

                            // Add event handlers for select all/none
                            $('.select-all-btn').click(function() {
                                $('.state-checkbox').prop('checked', true);
                            });

                            $('.select-none-btn').click(function() {
                                $('.state-checkbox').prop('checked', false);
                            });
                        }

                        // Update counter of selected states
                        updateSelectedCount();

                        // Add change event to update counter
                        $('.state-checkbox').change(function() {
                            updateSelectedCount();
                        });

                    } else {
                        stateCheckboxes.html(
                            '<div class="alert alert-warning state-error">No states found for this country.</div>'
                        );
                    }
                },
                error: function(xhr) {
                    console.error(xhr.responseText);
                    stateCheckboxes.html(
                        '<div class="alert alert-danger state-error">Error loading states. Please try again.</div>'
                    );
                }
            });
        }

        function updateSelectedCount() {
            var selectedCount = $('.state-checkbox:checked').length;
            var totalCount = $('.state-checkbox').length;

            $('#selectedCount').remove();
            $('#stateSelect').append(
                '<div id="selectedCount" class="mt-3 text-muted">' +
                selectedCount + ' of ' + totalCount + ' states selected' +
                '</div>'
            );
        }

        function saveSelectedStates() {
            var selectedStates = [];
            var serviceZoneUuid = $('#selectedCountryId').val();

            console.log("Service Zone UUID:", serviceZoneUuid);

            $('#stateSelect input:checked').each(function() {
                selectedStates.push($(this).val());
            });

            if (selectedStates.length > 0 && serviceZoneUuid) {
                // Show saving indicator
                $('#saveStates').html(
                    '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...'
                ).prop('disabled', true);

                // Get country ID for context
                var countryId = $('#countrySelect').val();

                $.ajax({
                    url: baseUrl + 'ajax/save-states',
                    method: 'POST',
                    data: {
                        states: selectedStates,
                        service_zone_uuid: serviceZoneUuid,
                        country_id: countryId,
                        _token: '{{ csrf_token() }}'
                    },
                    success: function(response) {
                        console.log(response);

                        // Reset button
                        $('#saveStates').html('Save States').prop('disabled', false);

                        // Show success message
                        showNotification('States updated successfully!', 'success');

                        // Close modal after successful save
                        $('#addStateModal').modal('hide');

                        // Optional: Reload the page to see changes
                        if (response.reload) {
                            setTimeout(function() {
                                location.reload();
                            }, 1500);
                        }
                    },
                    error: function(xhr) {
                        console.error(xhr.responseText);

                        // Reset button
                        $('#saveStates').html('Save States').prop('disabled', false);

                        // Show error message
                        showNotification('Error saving states. Please try again.', 'error');
                    }
                });
            } else if (!serviceZoneUuid) {
                showNotification('Error: No service zone ID found. Please try again.', 'error');
            } else {
                showNotification('Please select at least one state.', 'warning');
            }
        }

        function clearAddStateModal() {
            // Reset form
            $('#addStateModal form')[0]?.reset();

            // Clear all state checkboxes
            $('#stateSelect').empty();

            // Reset country dropdown
            $('#countrySelect').val('').trigger('change');

            // Clear service zone UUID from hidden input
            $('#selectedCountryId').val('');

            // Clear existing states
            existingStates = [];

            // Clear any error messages
            $('.state-error').remove();

            // Reset save button
            $('#saveStates').html('Save States').prop('disabled', false);
        }

        function showNotification(message, type) {
            // Remove existing notifications
            $('.custom-notification').remove();

            // Create notification
            var alertClass = type === 'success' ? 'alert-success' :
                type === 'error' ? 'alert-danger' :
                type === 'warning' ? 'alert-warning' : 'alert-info';

            var notification = $(
                '<div class="custom-notification alert ' + alertClass +
                ' alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
                message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                '</div>'
            );

            // Add to page
            $('body').append(notification);

            // Auto remove after 5 seconds
            setTimeout(function() {
                notification.alert('close');
            }, 5000);
        }
    </script>
@endpush




















Great  heres a **complete, copy-pasteable implementation** that does everything you asked:

* Add / update selected states (store **only the state IDs** as a JSON array in `cab_zones.states_id`)
* Return the saved list from the server
* Show selected state **names** in the table row (listing the selected values)
* Support prefill (when opening the modal) and update in-place

I'll give you: migration, model, routes, controllers, and a single Blade file (table + modal + JS). Drop these into your project and they should work together (adjust namespaces or paths if yours differ).

---

## 1) Migration  add `states_id` JSON to `cab_zones`

Create migration:

```bash
php artisan make:migration add_states_id_to_cab_zones_table --table=cab_zones
```

Paste into migration file:

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class AddStatesIdToCabZonesTable extends Migration
{
    public function up()
    {
        Schema::table('cab_zones', function (Blueprint $table) {
            if (! Schema::hasColumn('cab_zones', 'states_id')) {
                $table->json('states_id')->nullable()->after('service_zone_id');
            }
        });
    }

    public function down()
    {
        Schema::table('cab_zones', function (Blueprint $table) {
            if (Schema::hasColumn('cab_zones', 'states_id')) {
                $table->dropColumn('states_id');
            }
        });
    }
}
```

Run:

```
php artisan migrate
```

---

## 2) Model  `CabZone` cast (so `states_id` is array in PHP)

`app/Models/CabZone.php`:

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class CabZone extends Model
{
    protected $table = 'cab_zones';

    // So Eloquent returns states_id as PHP array
    protected $casts = [
        'states_id' => 'array',
    ];

    // Optional: relation to states if you want to use it elsewhere
    public function statesRelation()
    {
        return $this->belongsToMany(
            \App\Models\State::class,
            'cab_zone_state', // if you later use pivot
            'cab_zone_id',
            'state_id'
        );
    }
}
```

---

## 3) Routes

Add these to `routes/web.php` (web for CSRF):

```php
use App\Http\Controllers\LocationController;
use App\Http\Controllers\CabZoneController;

// Frontend AJAX: countries & states
Route::get('/api/countries', [LocationController::class, 'countries']);
Route::get('/api/countries/{country}/states', [LocationController::class, 'statesByCountry']);

// Get saved states for a given service-zone uuid (prefill modal)
Route::get('/admin/service-zones/{uuid}/states', [CabZoneController::class, 'getStatesForZone']);

// Save states (add/update)  stores ONLY state IDs array in cab_zones.states_id
Route::post('/ajax/save-states', [CabZoneController::class, 'saveStates'])->name('ajax.save-states');
```

---

## 4) Controllers

### `LocationController` (countries & states)

`app/Http/Controllers/LocationController.php`:

```php
<?php

namespace App\Http\Controllers;

use App\Models\Country;
use App\Models\State;
use Illuminate\Http\Request;

class LocationController extends Controller
{
    public function countries()
    {
        // returns [{id, name}, ...]
        $countries = Country::select('id','name')->orderBy('name')->get();
        return response()->json($countries);
    }

    public function statesByCountry($countryId)
    {
        // returns [{id, name}, ...]
        $states = State::where('country_id', $countryId)->select('id','name')->orderBy('name')->get();
        return response()->json($states);
    }
}
```

### `CabZoneController` (get prefills + save)

`app/Http/Controllers/CabZoneController.php`:

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;
use App\Models\CabZone;
use App\Models\State;

class CabZoneController extends Controller
{
    /**
     * Return saved country_id and states for prefill (modal)
     * Response:
     * {
     *   country_id: int|null,
     *   states_id: [id,id,...],
     *   states: [{id,name}, ...]
     * }
     */
    public function getStatesForZone($uuid)
    {
        // Find service_zone id by uuid
        $svc = \DB::table('service_zone_cities')->where('uuid', $uuid)->first();
        if (!$svc) {
            return response()->json(['message' => 'Service zone not found'], 404);
        }
        $serviceZoneId = $svc->id;

        // Find related cab_zone row (may or may not exist)
        $cabZone = CabZone::where('service_zone_id', $serviceZoneId)->first();

        $statesId = [];
        if ($cabZone && $cabZone->states_id) {
            $statesId = $cabZone->states_id;
        }

        // If service_zone_cities has country_id, return it (attempt)
        $countryId = $svc->country_id ?? null;

        // Provide state objects for display (names)
        $states = [];
        if (!empty($statesId)) {
            $states = State::whereIn('id', $statesId)->select('id','name')->orderBy('name')->get();
        }

        return response()->json([
            'country_id' => $countryId,
            'states_id' => $statesId,
            'states' => $states,
        ]);
    }

    /**
     * Save states (store only integer IDs in cab_zones.states_id as JSON array)
     * Request:
     * - service_zone_id (uuid)
     * - states (array ints)
     *
     * Response:
     * {
     *   success: true,
     *   cab_zone_id: int,
     *   states_id: [4002,4003,...],
     *   states: [{id,name},...],
     *   state_count: int
     * }
     */
    public function saveStates(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'service_zone_id' => 'required|string',
            'states' => 'nullable|array',
            'states.*' => 'integer|exists:states,id',
        ]);

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed',
                'errors' => $validator->errors()
            ], 422);
        }

        $uuid = $request->input('service_zone_id');
        $stateIds = $request->input('states', []);

        // sanitize: ints, positive, unique
        $stateIds = array_values(array_unique(array_map('intval', array_filter($stateIds, function($v) {
            return is_numeric($v) && intval($v) > 0;
        }))));

        // convert uuid -> service_zone_cities.id
        $svc = \DB::table('service_zone_cities')->where('uuid', $uuid)->first();
        if (!$svc) {
            return response()->json(['success' => false, 'message' => 'Service zone not found'], 404);
        }
        $serviceZoneId = $svc->id;

        // find or create cab_zone row
        $cabZone = CabZone::firstOrCreate(['service_zone_id' => $serviceZoneId]);

        // Save only IDs (Eloquent cast will handle JSON)
        $cabZone->states_id = $stateIds;
        $cabZone->save();

        // prepare states objects to return
        $states = [];
        if (!empty($stateIds)) {
            $states = State::whereIn('id', $stateIds)->select('id','name')->orderBy('name')->get();
        }

        return response()->json([
            'success' => true,
            'cab_zone_id' => $cabZone->id,
            'states_id' => $cabZone->states_id,
            'states' => $states,
            'state_count' => count($cabZone->states_id ?? [])
        ]);
    }
}
```

---

## 5) Blade  full page (table, modal, JS).

Place this in the Blade view that renders `$zones` and `$countries`. It assumes `$zones` contains service-zone rows and `$countries` is an array of countries (you can also fetch countries via AJAX).

**Important:** this Blade uses Bootstrap 4/5 jQuery modal markup (your project already has Bootstrap/jQuery). Adjust only if different.

```blade
@extends('layouts.app', ['isSidebar' => true, 'isNavbar' => true, 'isFooter' => false])

@push('styles')
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
@endpush

@section('content')
<div class="content-header row top_header">
    <h4 class="py-2 mb-0"><span class="text-muted fw-light">City Services Zone List</span></h4>
    <div class="d-flex align-content-center flex-wrap gap-3">
        <a href="{{ route('admin.service-zones.create') }}" class="btn btn-primary">Add Service City</a>
    </div>
</div>

<div class="content-body">
    <section id="row-selection">
        <div class="card">
            <div class="card-body">
                <table class="table table-striped table-bordered" id="zonesTable">
                    <thead>
                        <tr>
                            <th>Sr. No.</th>
                            <th>City</th>
                            <th>Selected States</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach ($zones as $key => $valu)
                        @php
                            // Get display names for selected states (if cabZone exists)
                            $cabzone = $valu->cabZone->first() ?? null;
                            $selectedStates = [];
                            if ($cabzone && $cabzone->states_id) {
                                // states_id is stored as json array; use helper or eager load to avoid N+1
                                $selectedStates = \App\Models\State::whereIn('id', $cabzone->states_id)->pluck('name')->toArray();
                            }
                        @endphp
                        <tr data-uuid="{{ $valu->uuid }}">
                            <td>{{ $key + 1 }}</td>
                            <td>{{ $valu->city?->name ?? '-' }}</td>
                            <td class="selected-states-cell">
                                @if(!empty($selectedStates))
                                    {{ implode(', ', $selectedStates) }}
                                @else
                                    <span class="text-muted">No states selected</span>
                                @endif
                            </td>
                            <td>
                                @if($valu->status == 1)
                                    <a href="#" class="btn btn-sm btn-primary addStateBtn"
                                       data-uuid="{{ $valu->uuid }}"
                                       data-country-id="{{ $valu->country_id ?? '' }}">
                                       <i class="fas fa-plus-circle"></i> Edit States
                                    </a>
                                @else
                                    <button class="btn btn-sm btn-secondary" disabled>Inactive</button>
                                @endif
                            </td>
                        </tr>
                    @endforeach
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<!-- Modal -->
<div class="modal fade" id="addStateModal" tabindex="-1" role="dialog" aria-labelledby="addStateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <form id="addStateModalForm" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title" id="addStateModalLabel">Select States</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="modal_service_zone_uuid" />

            <div class="form-group">
                <label for="countrySelect">Country</label>
                <select id="countrySelect" class="form-control">
                    <option value="">-- Select Country --</option>
                    @foreach ($countries as $c)
                        <option value="{{ $c->id }}">{{ $c->name }}</option>
                    @endforeach
                </select>
            </div>

            <div class="form-group">
                <label>States</label>
                <div id="stateContainer" style="max-height:300px; overflow:auto; border:1px solid #eee; padding:8px; border-radius:4px;">
                    <p class="text-muted">Select a country to load states</p>
                </div>
            </div>

            <div id="addStateError" class="text-danger small d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" id="saveStates" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>

@endsection

@push('scripts')
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Make sure CSRF is available for AJAX
$.ajaxSetup({
    headers: { 'X-CSRF-TOKEN': '{{ csrf_token() }}' }
});

$(function() {
    const baseUrl = window.baseUrl || '/';

    // Open modal and load preselected states
    $(document).on('click', '.addStateBtn', function(e) {
        e.preventDefault();
        $('#addStateError').addClass('d-none').text('');
        const uuid = $(this).data('uuid');
        const initialCountryId = $(this).data('country-id') || '';

        $('#modal_service_zone_uuid').val(uuid);
        if (initialCountryId) {
            $('#countrySelect').val(initialCountryId);
        } else {
            $('#countrySelect').val('');
        }

        // show loading
        $('#stateContainer').html('<p class="text-muted small">Loading selected states...</p>');

        // Prefill: get existing saved states for this uuid
        $.get('/admin/service-zones/' + uuid + '/states')
            .done(function(res) {
                const countryId = res.country_id || initialCountryId || '';
                $('#countrySelect').val(countryId);
                loadStates(countryId, res.states_id || []);
                $('#addStateModal').modal('show');
            })
            .fail(function() {
                if (initialCountryId) {
                    loadStates(initialCountryId, []);
                } else {
                    $('#stateContainer').html('<p class="text-muted small">Select a country to load states.</p>');
                }
                $('#addStateModal').modal('show');
            });
    });

    // when country changes
    $('#countrySelect').on('change', function() {
        const cid = $(this).val();
        if (!cid) {
            $('#stateContainer').html('<p class="text-muted small">Select a country to load states.</p>');
            return;
        }
        loadStates(cid, []);
    });

    // Load states for country and pre-check ids
    function loadStates(countryId, preSelectedIds = []) {
        $('#stateContainer').html('<p class="text-muted small">Loading states...</p>');

        $.get(baseUrl + 'api/countries/' + countryId + '/states')
            .done(function(list) {
                if (!Array.isArray(list) || list.length === 0) {
                    $('#stateContainer').html('<p class="text-muted small">No states found for this country.</p>');
                    return;
                }
                let html = '<div class="list-group">';
                list.forEach(function(s) {
                    const checked = (preSelectedIds && preSelectedIds.indexOf(s.id) !== -1) ? 'checked' : '';
                    html += `<label class="list-group-item">
                                <input type="checkbox" class="state-checkbox me-2" value="${s.id}" ${checked}>
                                ${s.name}
                             </label>`;
                });
                html += '</div>';
                $('#stateContainer').html(html);
            })
            .fail(function(xhr) {
                console.error('Error loading states', xhr.responseText || xhr.statusText);
                $('#stateContainer').html('<div class="text-danger small">Failed to load states. Try again.</div>');
            });
    }

    // Save selected states (store only IDs)
    $('#saveStates').on('click', function(e) {
        e.preventDefault();
        $('#addStateError').addClass('d-none').text('');
        const uuid = $('#modal_service_zone_uuid').val();
        if (!uuid) {
            $('#addStateError').removeClass('d-none').text('Invalid service zone. Close and reopen modal.');
            return;
        }

        // collect selected ids and dedupe
        const selected = [];
        $('#stateContainer').find('.state-checkbox:checked').each(function() {
            const v = parseInt($(this).val(), 10);
            if (!isNaN(v) && v > 0) selected.push(v);
        });
        const uniq = Array.from(new Set(selected));

        // send to server
        const payload = {
            service_zone_id: uuid,
            states: uniq
        };

        const $btn = $(this);
        $btn.prop('disabled', true).text('Saving...');

        $.post(baseUrl + 'ajax/save-states', payload)
            .done(function(resp) {
                if (resp.success) {
                    // update table cell: show names (server returned 'states' array)
                    const $row = $(`tr[data-uuid="${uuid}"]`);
                    if (resp.states && resp.states.length > 0) {
                        const names = resp.states.map(s => s.name).join(', ');
                        $row.find('.selected-states-cell').text(names);
                    } else {
                        $row.find('.selected-states-cell').html('<span class="text-muted">No states selected</span>');
                    }

                    $('#addStateModal').modal('hide');
                } else {
                    $('#addStateError').removeClass('d-none').text(resp.message || 'Save failed');
                }
            })
            .fail(function(xhr) {
                let msg = 'Error saving states.';
                if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                $('#addStateError').removeClass('d-none').text(msg);
            })
            .always(function() {
                $btn.prop('disabled', false).text('Save');
            });
    });

    // optional: initialize datatable
    $('#zonesTable').DataTable && $('#zonesTable').DataTable();

    // cleanup modal on close
    $('#addStateModal').on('hidden.bs.modal', function () {
        $('#modal_service_zone_uuid').val('');
        $('#stateContainer').html('<p class="text-muted small">Select a country to load states.</p>');
        $('#addStateError').addClass('d-none').text('');
    });
});
</script>
@endpush
```

---

## 6) Notes & small tips

* The controller stores only the IDs in `cab_zones.states_id` (JSON). Example DB cell content:

  ```
  [4002,4003,4005,4006]
  ```
* The controller responds with `states` array (objects) so the frontend updates text with names.
* If you prefer to fetch countries via AJAX instead of preloading `$countries` in the Blade, remove the server-side `@foreach` and call `/api/countries` from JS  both will work.
* Performance: If you have many rows, it's better to eager-load related cabZone to avoid N+1. Example in controller that serves the Blade view:

  ```php
  $zones = ServiceZoneCity::with('cabZone')->get();
  ```

  and ensure `cabZone()` relation returns the cab_zones records.

---

If you want, I can now:

* produce a small migration to **backfill** `states_id` from any existing pivot table or legacy column, or
* convert the checkbox UI into a searchable **Select2 multi-select** (better when the list is long).

Which one shall I add next?













@extends('layouts.app', ['isSidebar' => true, 'isNavbar' => true, 'isFooter' => false])

@push('styles')
    <link rel="stylesheet" href="{{ asset('app-assets/vendors/css/forms/icheck/icheck.css') }}">
    <link rel="stylesheet" href="{{ asset('app-assets/vendors/css/forms/toggle/bootstrap-switch.min.css') }}">
    <link rel="stylesheet" href="{{ asset('app-assets/vendors/css/forms/toggle/switchery.min.css') }}">
    <link rel="stylesheet" href="{{ asset('app-assets/css/plugins/forms/switch.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/vendor/datatables/responsive.bootstrap4.min.css') }}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
@endpush

@section('content')
    <div class="content-header row top_header">
        <h4 class="py-2 mb-0"><span class="text-muted fw-light">{{ __('City Services Zone List') }}</span></h4>
        <div class="d-flex align-content-center flex-wrap gap-3">
            <a href="{{ route('admin.service-zones.create') }}" class="btn btn-primary">{{ __('Add Service City') }}</a>
            {{-- <button class="btn btn-secondary" data-toggle="modal"
                data-target="#addStateModal">{{ __('Add State') }}</button> --}}
        </div>
    </div>

    <div class="content-body">
        <section id="row-selection">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <a class="heading-elements-toggle"><i class="fa fa-ellipsis-v font-medium-3"></i></a>
                            <div class="heading-elements">
                                <ul class="list-inline mb-0">
                                    <li><a data-action="collapse"><i class="ft-minus"></i></a></li>
                                    <li><a data-action="reload"><i class="ft-rotate-cw"></i></a></li>
                                    <li><a data-action="expand"><i class="ft-maximize"></i></a></li>
                                    <li><a data-action="close"><i class="ft-x"></i></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-content collapse show">
                            <div class="card-body">
                                <table class="table table-striped table-bordered customdatatable" id="carTooable">
                                    <thead>
                                        <tr>
                                            <th>{{ __('Sr. No.') }}</th>
                                            <th>{{ __('State Name') }}</th>
                                            <th>{{ __('Service Area') }}</th>
                                            <th>{{ __('Action') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach ($zones as $key => $valu)
                                            <tr>
                                                <td>{{ $key + 1 }}</td>
                                                <input type="hidden" class="serviceZoneId" id="serviceZoneId"
                                                    value="{{ $valu?->uuid }}">
                                                {{-- @dd($valu) --}}
                                                @php
                                                    $cabezones = $valu?->cabZone->first();
                                                @endphp
                                                <td>
                                                    @if (isset($cabezones) && isset($cabezones->states_id) && $cabezones->states_id !== null)
                                                        {{ findState($cabezones->states_id, 'name') }}
                                                    @else
                                                        {{ $valu->state?->name }}
                                                    @endif
                                                    @if ($valu->status == 1 && $valu?->id !== null && $valu?->city?->id !== null)
                                                        @if (!$valu->cabZone->first())
                                                            <div class="text-right">
                                                                <a href="#" class="btn btn-sm btn-primary disabled"
                                                                    data-toggle="modal" data-target="#addStateModal">
                                                                    <i class="fas fa-plus-circle"></i>
                                                                </a>
                                                            </div>
                                                        @else
                                                            <div class="text-right">
                                                                <a href="#" class="btn btn-sm btn-primary addStateBtn"
                                                                    data-toggle="modal" data-uuid="{{ $valu->uuid }}"
                                                                    data-target="#addStateModal">
                                                                    <i class="fas fa-plus-circle"></i>
                                                                </a>
                                                            </div>
                                                        @endif
                                                    @else
                                                        <div class="text-right">
                                                            <a href="#" class="btn btn-sm btn-primary disabled"
                                                                data-toggle="modal" data-target="#addStateModal">
                                                                <i class="fas fa-plus-circle"></i>
                                                            </a>
                                                        </div>
                                                    @endif
                                                </td>
                                                <td>
                                                    @if ($valu->status == 1 && $valu?->id !== null && $valu?->city?->id !== null)
                                                        @if (!$valu->cabZone->first())
                                                            <a href="{{ route('admin.service-zones.editPolygonDraw', [$valu?->id, $valu?->city->id]) }}"
                                                                class="btn btn-primary">
                                                                <i class="fa-solid fa-draw-polygon"></i> Add Service Area
                                                            </a>
                                                        @endif
                                                        @if ($valu->cabZone->first())
                                                            <a href="{{ route('admin.service-zones.viewPolygonDraw', [$valu->id, $valu->city->id]) }}"
                                                                class="btn btn-secondary">
                                                                <i class="fa-solid fa-street-view"></i> View
                                                            </a>
                                                        @endif
                                                        @if ($valu->cabZone->first())
                                                            <a class="btn btn-danger deleteData"
                                                                data-uuid="{{ $valu->cabZone->first()->uuid }}"
                                                                href="javascript:void(0)" data-table="cab_zones">
                                                                <i class="fa-solid fa-trash"></i> Delete
                                                            </a>
                                                        @endif
                                                    @else
                                                        @if (!$valu->cabZone->first())
                                                            <button class="btn btn-secondary" disabled>
                                                                <i class="fa-solid fa-draw-polygon"></i> Add Service Area
                                                            </button>
                                                        @else
                                                            <button class="btn btn-secondary" disabled>
                                                                <i class="fa-solid fa-street-view"></i> View
                                                            </button>
                                                            <button class="btn btn-danger" disabled>
                                                                <i class="fa-solid fa-trash"></i> Delete
                                                            </button>
                                                        @endif
                                                    @endif
                                                </td>
                                                <td>
                                                    <div class="">
                                                        <label class="switch">
                                                            <input type="checkbox" class="changeStatus"
                                                                id="switchery_inline{{ $valu->uuid }}" name="is_active"
                                                                {{ $valu->status ? 'checked' : '' }}
                                                                data-uuid="{{ $valu->uuid }}"
                                                                data-table="service_zone_cities" data-message="deactive">
                                                            <span class="slider round"></span>
                                                        </label>
                                                        <a class="deleteData" href="javascript:void(0)"
                                                            data-table="service_zone_cities"
                                                            data-uuid="{{ $valu->uuid }}"> <span
                                                                style="margin-right: 5px;"><i
                                                                    class="fa-solid fa-trash"></i></span>Delete</a>
                                                    </div>
                                                </td>
                                            </tr>
                                        @endforeach
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
        </section>
    </div>

    <!-- Modal for Add State -->
    <div class="modal fade" id="addStateModal" tabindex="-1" role="dialog" aria-labelledby="addStateModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStateModalLabel">{{ __('Add State') }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="countrySelect">{{ __('Select Country') }}</label>
                        <select id="countrySelect" class="form-control">
                            <option value="">{{ __('Select Country') }}</option>
                            @foreach ($countries as $country)
                                <option value="{{ $country->id }}" {{ $country->id == 101 ? 'selected' : '' }}>
                                    {{ $country->name }}
                                </option>
                            @endforeach
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="stateSelect">{{ __('Select States') }}</label>
                        <select id="stateSelect" class="form-control" multiple>
                            <!-- States will be populated based on selected country -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ __('Close') }}</button>
                    <button type="button" class="btn btn-primary" id="saveStates">{{ __('Save States') }}</button>
                </div>
            </div>
        </div>
    </div>
@endsection

@push('scripts')
    <script src="{{ asset('app-assets/vendors/js/forms/icheck/icheck.min.js') }}"></script>
    <script src="{{ asset('app-assets/vendors/js/forms/toggle/bootstrap-switch.min.js') }}"></script>
    <script src="{{ asset('app-assets/vendors/js/forms/toggle/switchery.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/dataTables.bootstrap4.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/dataTables.responsive.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/responsive.bootstrap4.min.js') }}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.flash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{{ asset('assets/custom/js/datatableajax.js') }}"></script>

    <script>
        $(document).ready(function() {

                // Handle "Add State" button click
                $('.addStateBtn').on('click', function(event) {
                    resetAddStateModal();
                });

                // Handle country dropdown change
                $('#countrySelect').change(function() {
                    var countryId = $(this).val();
                    loadStatesForCountry(countryId);
                });

                // Handle "Save States" button click
                $('#saveStates').click(function() {
                    saveSelectedStates();
                });

                // Clear modal when it's hidden
                $('#addStateModal').on('hidden.bs.modal', function() {
                    clearAddStateModal();
                });
            });

            function resetAddStateModal() {
                // Reset the country dropdown
                $('#countrySelect').val('').trigger('change');

                // Clear all state checkboxes
                $('#stateSelect').empty();

                // Reset any error messages if present
                $('.state-error').remove();

                // Also reset the form if it's inside a form element
                $('#addStateModal form')[0]?.reset();
            }

            function loadStatesForCountry(countryId) {
                var stateCheckboxes = $('#stateSelect');

                // Clear previous checkboxes and any error messages
                stateCheckboxes.empty();
                $('.state-error').remove();

                if (countryId) {
                    $.ajax({
                        url: baseUrl + 'ajax/states/' + countryId,
                        method: 'GET',
                        success: function(data) {
                            if (data.length > 0) {
                                $.each(data, function(index, state) {
                                    stateCheckboxes.append(
                                        '<div class="form-check">' +
                                        '<input class="form-check-input" type="checkbox" value="' +
                                        state.id + '" id="state' + state.id + '">' +
                                        '<label class="form-check-label" for="state' +
                                        state.id + '">' + state.name + '</label>' +
                                        '</div>'
                                    );
                                });
                            } else {
                                stateCheckboxes.append(
                                    '<div class="alert alert-warning state-error">No states found for this country.</div>'
                                );
                            }
                        },
                        error: function(xhr) {
                            console.error(xhr.responseText);
                            stateCheckboxes.append(
                                '<div class="alert alert-danger state-error">Error loading states. Please try again.</div>'
                            );
                        }
                    });
                } else {
                    stateCheckboxes.append(
                        '<div class="text-muted state-error">Please select a country first.</div>'
                    );
                }
            }

            function saveSelectedStates() {
                var selectedStates = [];
                var modal = $('#addStateModal');
                var serviceZoneId = modal.data('serviceZoneId');

                // If service zone ID is not found in the modal, try to get it from the last clicked button
                if (!serviceZoneId) {
                    serviceZoneId = $('.addStateBtn').data('uuid');
                }

                console.log("Service Zone ID:", serviceZoneId);

                $('#stateSelect input:checked').each(function() {
                    selectedStates.push($(this).val());
                });

                if (selectedStates.length > 0 && serviceZoneId) {
                    $.ajax({
                        url: baseUrl + 'ajax/save-states',
                        method: 'POST',
                        data: {
                            states: selectedStates,
                            service_zone_id: serviceZoneId,
                            _token: '{{ csrf_token() }}'
                        },
                        success: function(response) {
                            console.log(response);
                            showToast('States added successfully!', 'success');
                        },
                        error: function(xhr) {
                            console.error(xhr.responseText);
                            showToast('Error saving states. Please try again.', 'error');
                        }
                    });
                } else if (!serviceZoneId) {
                    showToast('Error: No service zone ID found. Please open the modal again.', 'error');
                } else {
                    showToast('Please select at least one state.', 'warning');
                }
            }

            function clearAddStateModal() {
                // Reset form if exists
                $('#addStateModal form')[0]?.reset();

                // Clear all state checkboxes
                $('#stateSelect').empty();

                // Reset country dropdown
                $('#countrySelect').val('').trigger('change');

                // Clear service zone ID
                $('#serviceZoneId').val('');
            }

            function showToast(message, type = 'info') {
                // You can implement your toast notification here
                // Example with Bootstrap toast if available
                console.log(type.toUpperCase() + ': ' + message);
            }







            // $('.addStateBtn').on('click', function(event) {
            //     var button = $(event.relatedTarget);

            //     // Reset the country dropdown
            //     $('#countrySelect').val('').trigger('change');

            //     // Clear all state checkboxes
            //     $('#stateSelect').empty();

            //     // Reset any error messages if present
            //     $('.state-error').remove();

            //     // Also reset the form if it's inside a form element
            //     $('#addStateModal form')[0]?.reset();

            // });

            // $('#countrySelect').change(function() {
            //     var countryId = $(this).val();
            //     var stateCheckboxes = $('#stateSelect');

            //     // Clear previous checkboxes and any error messages
            //     stateCheckboxes.empty();
            //     $('.state-error').remove();

            //     if (countryId) {
            //         $.ajax({
            //             url: baseUrl + 'ajax/states/' + countryId,
            //             method: 'GET',
            //             success: function(data) {
            //                 if (data.length > 0) {
            //                     $.each(data, function(index, state) {
            //                         stateCheckboxes.append(
            //                             '<div class="form-check">' +
            //                             '<input class="form-check-input" type="checkbox" value="' +
            //                             state.id + '" id="state' + state.id + '">' +
            //                             '<label class="form-check-label" for="state' +
            //                             state.id + '">' + state.name + '</label>' +
            //                             '</div>'
            //                         );
            //                     });
            //                 } else {
            //                     stateCheckboxes.append(
            //                         '<div class="alert alert-warning state-error">No states found for this country.</div>'
            //                     );
            //                 }
            //             },
            //             error: function(xhr) {
            //                 console.error(xhr.responseText);
            //                 stateCheckboxes.append(
            //                     '<div class="alert alert-danger state-error">Error loading states. Please try again.</div>'
            //                 );
            //             }
            //         });
            //     } else {
            //         stateCheckboxes.append(
            //             '<div class="text-muted state-error">Please select a country first.</div>'
            //         );
            //     }
            // });


            // $('#saveStates').click(function() {
            //     var selectedStates = [];

            //     // Get the modal instance and find which button opened it
            //     var modal = $('#addStateModal');
            //     var serviceZoneId = null;

            //     // Try to get from modal data first
            //     serviceZoneId = modal.data('serviceZoneId');

            //     // If not found, try to get from the last clicked button
            //     if (!serviceZoneId) {
            //         // This assumes you're tracking the last clicked button
            //         serviceZoneId = $('.addStateBtn').last().data('uuid');
            //     }

            //     console.log("Service Zone ID:", serviceZoneId);

            //     $('#stateSelect input:checked').each(function() {
            //         selectedStates.push($(this).val());
            //     });

            //     if (selectedStates.length > 0 && serviceZoneId) {
            //         $.ajax({
            //             url: baseUrl + 'ajax/save-states',
            //             method: 'POST',
            //             data: {
            //                 states: selectedStates,
            //                 service_zone_id: serviceZoneId,
            //                 _token: '{{ csrf_token() }}'
            //             },
            //             success: function(response) {
            //                 console.log(response);
            //                 // $('#addStateModal').modal('hide');
            //                 showToast('States added successfully!', 'success');
            //             },
            //             error: function(xhr) {
            //                 console.error(xhr.responseText);
            //                 showToast('Error saving states. Please try again.', 'error');
            //             }
            //         });
            //     } else if (!serviceZoneId) {
            //         alert('Error: No service zone ID found. Please open the modal again.');
            //     } else {
            //         alert('Please select at least one state.');
            //     }
            // });

            // // Optional: Clear form when modal is closed completely
            // $('#addStateModal').on('hidden.bs.modal', function() {
            //     // Reset form if exists
            //     $('#addStateModal form')[0]?.reset();

            //     // Clear all state checkboxes
            //     $('#stateSelect').empty();

            //     // Reset country dropdown
            //     $('#countrySelect').val('').trigger('change');

            //     // Clear service zone ID
            //     $('#serviceZoneId').val('');
            // });

            // // Optional: Toast notification function
            // function showToast(message, type = 'info') {
            //     // You can implement your toast notification here
            //     // Example with Bootstrap toast if available
            //     console.log(type.toUpperCase() + ': ' + message);
            // }
        // });
    </script>
@endpush






 public function saveStates(Request $request)
    {
        // dd($request->all());
        $id = uuidtoid($request->service_zone_id, 'service_zone_cities');
        //    $state=ServiceZoneCity::find($id);
        $state = CabZone::where('service_zone_id', $id)->first();

        // dd($state, $request->state_id);
        $state->states_id = $request->states;
        $state->save();
        // dd($state);
        return response()->json($state);
    }
















@extends('layouts.app', ['isSidebar' => true, 'isNavbar' => true, 'isFooter' => false])

@push('styles')
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
@endpush

@section('content')
<div class="content-header row top_header">
    <h4 class="py-2 mb-0">
        <span class="text-muted fw-light">City Services Zone List</span>
    </h4>
</div>

<div class="content-body">
    <div class="card">
        <div class="card-body">
            <table class="table table-bordered" id="zonesTable">
                <thead>
                    <tr>
                        <th>Sr No</th>
                        <th>City</th>
                        <th>States</th>
                    </tr>
                </thead>
                <tbody>
                @foreach($zones as $k => $z)
                    <tr>
                        <td>{{ $k + 1 }}</td>

                        <td>{{ $z->city?->name }}</td>

                        <td>
                            <span class="state-name">
                                {{-- show number of states selected --}}
                                @php $c = $z->states()->count(); @endphp
                                {{ $c > 0 ? "$c states selected" : "No states selected" }}
                            </span>

                            <span class="badge bg-success ms-1 open-states-modal"
                                  data-uuid="{{ $z->uuid }}"
                                  data-country-id="{{ $z->country_id ?? '' }}"
                                  style="cursor:pointer;">
                                change
                            </span>
                        </td>
                    </tr>
                @endforeach
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- -------------------------- -->
<!--  STATES SELECT MODAL      -->
<!-- -------------------------- -->
<div class="modal fade" id="statesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <form id="statesModalForm">
                <div class="modal-header">
                    <h5 class="modal-title">Select States</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" id="modal_uuid">

                    <div class="mb-3">
                        <label class="form-label">Country</label>
                        <select id="countrySelect" class="form-select">
                            <option value="">Select country</option>
                        </select>
                    </div>

                    <div id="statesContainer" style="max-height:350px; overflow-y:auto;">
                        <p class="text-muted">Select a country to load states...</p>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" id="saveStatesBtn" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>

        </div>
    </div>
</div>


@endsection


@push('scripts')
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<script>
$(function() {
    const modalEl = document.getElementById('statesModal');
    const modal = new bootstrap.Modal(modalEl);

    let currentUuid = null;

    // ------------------------------
    // Load countries
    // ------------------------------
    function loadCountries(selectedId = null) {
        $("#countrySelect").html('<option>Loading...</option>');

        $.get("/api/countries", function(list) {
            let html = '<option value="">Select country</option>';
            list.forEach(c => {
                html += `<option value="${c.id}" ${selectedId == c.id ? 'selected':''}>${c.name}</option>`;
            });
            $("#countrySelect").html(html);
        });
    }

    // ------------------------------
    // Load states by country
    // ------------------------------
    function loadStates(countryId, selectedStateIds = []) {
        $("#statesContainer").html("<p>Loading states...</p>");

        $.get(`/api/countries/${countryId}/states`, function(list) {

            if (list.length === 0) {
                $("#statesContainer").html("<p>No states found.</p>");
                return;
            }

            let html = `<div class="list-group">`;
            list.forEach(s => {
                const chk = selectedStateIds.includes(s.id) ? "checked" : "";
                html += `
                    <label class="list-group-item">
                        <input type="checkbox" class="state-checkbox me-2" value="${s.id}" ${chk}>
                        ${s.name}
                    </label>
                `;
            });
            html += `</div>`;

            $("#statesContainer").html(html);
        });
    }

    // ------------------------------
    // When clicking "change" badge
    // ------------------------------
    $(document).on("click", ".open-states-modal", function() {

        currentUuid = $(this).data("uuid");
        const countryId = $(this).data("country-id") || "";

        $("#modal_uuid").val(currentUuid);

        loadCountries(countryId);

        // Load existing selected states
        $.get(`/admin/service-zones/${currentUuid}/states`, function(res) {

            if (res.country_id) {
                $("#countrySelect").val(res.country_id);
                loadStates(res.country_id, res.state_ids);
            } else if (countryId) {
                $("#countrySelect").val(countryId);
                loadStates(countryId, []);
            } else {
                $("#statesContainer").html(`<p>Select a country...</p>`);
            }

            modal.show();
        });
    });

    // ------------------------------
    // Changing country reloads states
    // ------------------------------
    $("#countrySelect").on("change", function() {
        const id = $(this).val();
        if (id) loadStates(id, []);
        else $("#statesContainer").html("<p>Select a country...</p>");
    });


    // ------------------------------
    // SAVE STATES
    // ------------------------------
    $("#saveStatesBtn").on("click", function() {
        const uuid = $("#modal_uuid").val();

        const selected = [];
        $(".state-checkbox:checked").each(function() {
            selected.push(parseInt($(this).val()));
        });

        $("#saveStatesBtn").prop("disabled", true).text("Saving...");

        $.ajax({
            url: `/admin/service-zones/${uuid}/update-states`,
            type: "PATCH",
            data: {
                states_id: selected,
                _token: "{{ csrf_token() }}"
            },
            success: function(res) {
                modal.hide();
                $("#saveStatesBtn").prop("disabled", false).text("Save");

                // Update row dynamically
                const badge = $(`.open-states-modal[data-uuid="${uuid}"]`);
                const stateNameCell = badge.closest("td").find(".state-name");

                stateNameCell.text(res.count + " states selected");
            },
            error: function() {
                alert("Error saving states.");
                $("#saveStatesBtn").prop("disabled", false).text("Save");
            }
        });

    });

});
</script>
@endpush









// app/Http/Controllers/LocationController.php
namespace App\Http\Controllers;

use App\Models\Country;
use App\Models\State;
use Illuminate\Http\Request;

class LocationController extends Controller
{
    public function countries()
    {
        $countries = Country::select('id','name')->orderBy('name')->get();
        // return minimal JSON
        return response()->json($countries);
    }

    public function statesByCountry($countryId)
    {
        $states = State::where('country_id', $countryId)->select('id','name')->orderBy('name')->get();
        return response()->json($states);
    }
}


// app/Http/Controllers/ServiceZoneController.php
namespace App\Http\Controllers;

use App\Models\ServiceZoneCity;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;

class ServiceZoneController extends Controller
{
    // Return saved country_id and state_ids to prefill the modal
    public function getStatesForZone($uuid)
    {
        $zone = ServiceZoneCity::where('uuid', $uuid)->with('states')->firstOrFail();

        $countryId = $zone->country_id ?? null;
        $stateIds = $zone->states->pluck('id')->toArray();

        // optionally include state objects for display
        $states = $zone->states->map(function($s){
            return ['id' => $s->id, 'name' => $s->name];
        });

        return response()->json([
            'country_id' => $countryId,
            'state_ids' => $stateIds,
            'states' => $states,
        ]);
    }

    // Update selected states (array)
    public function updateStates(Request $request, $uuid)
    {
        $validator = Validator::make($request->all(), [
            'states_id' => 'array',
            'states_id.*' => 'integer|exists:states,id',
        ]);

        if ($validator->fails()) {
            return response()->json(['message' => 'Invalid input', 'errors' => $validator->errors()], 422);
        }

        $zone = ServiceZoneCity::where('uuid', $uuid)->firstOrFail();

        $stateIds = $request->input('states_id', []);

        // sync pivot
        $zone->states()->sync($stateIds);

        return response()->json(['success' => true, 'count' => count($stateIds)]);
    }
}


use App\Http\Controllers\LocationController;
use App\Http\Controllers\ServiceZoneController;

Route::middleware(['auth','admin'])->group(function () {
    // AJAX: countries and states (used by modal)
    Route::get('/api/countries', [LocationController::class, 'countries']);
    Route::get('/api/countries/{country}/states', [LocationController::class, 'statesByCountry']);

    // Get saved states for a service zone (preselect)
    Route::get('/admin/service-zones/{uuid}/states', [ServiceZoneController::class, 'getStatesForZone']);

    // Update selected states for a zone
    Route::patch('/admin/service-zones/{uuid}/update-states', [ServiceZoneController::class, 'updateStates']);
});



















Nice  below is a ready-to-drop-in Laravel example that follows the same idea: a button opens a Bootstrap modal in a Blade view, the country `<select>` is populated from the database, when a country is chosen the states are fetched by AJAX and rendered as **checkboxes**, and the selected values are POSTed to the server and validated.

I'll give you the routes, controller, a simple controller-level implementation (uses `Country` and `State` Eloquent models), and the Blade file with vanilla JS (fetch) so you don't need jQuery.

---

# 1) Routes (`routes/web.php`)

```php
use App\Http\Controllers\LocationController;

Route::get('/locations', [LocationController::class, 'index'])->name('locations.index');
Route::get('/locations/states/{country}', [LocationController::class, 'states'])->name('locations.states');
Route::post('/locations/save', [LocationController::class, 'save'])->name('locations.save');
```

---

# 2) Controller (`app/Http/Controllers/LocationController.php`)

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\Country;
use App\Models\State;
use Illuminate\Support\Facades\Validator;

class LocationController extends Controller
{
    // Show view with countries
    public function index()
    {
        $countries = Country::select('id', 'name')->orderBy('name')->get();
        return view('locations.index', compact('countries'));
    }

    // Return JSON states for selected country
    public function states($countryId)
    {
        $states = State::where('country_id', $countryId)
                       ->select('id', 'name')
                       ->orderBy('name')
                       ->get();

        return response()->json($states);
    }

    // Save selection (example: store into user meta or a table)
    public function save(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'country_id' => 'required|exists:countries,id',
            'state_ids'  => 'required|array|min:1',
            'state_ids.*'=> 'exists:states,id'
        ]);

        if ($validator->fails()) {
            // if AJAX request, return json, otherwise redirect back with errors
            if ($request->wantsJson() || $request->ajax()) {
                return response()->json(['errors' => $validator->errors()], 422);
            }
            return redirect()->back()->withErrors($validator)->withInput();
        }

        $data = $validator->validated();

        // Example saving: attach to current user (adjust to your app)
        // auth()->user()->update(['country_id' => $data['country_id']]);
        // auth()->user()->states()->sync($data['state_ids']); // if you have a many-to-many

        // for demo we just return success JSON
        return response()->json(['message' => 'Selection saved successfully.']);
    }
}
```

> Note: adapt the saving part to your application's models (e.g. `User::states()` relation or a separate table). The controller returns JSON for AJAX convenience.

---

# 3) Blade view (`resources/views/locations/index.blade.php`)

```blade
@extends('layouts.app')

@section('content')
<div class="container py-4">
  <h1>Choose Country & States</h1>

  <div id="alerts"></div>

  <button id="openModalBtn" class="btn btn-primary">Open modal</button>

  <!-- Modal -->
  <div class="modal fade" id="locationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="locationForm" class="modal-content" onsubmit="return false;">
        @csrf
        <div class="modal-header">
          <h5 class="modal-title">Select Country & States</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="country" class="form-label">Country</label>
            <select id="country" name="country_id" class="form-select" required>
              <option value="">-- Select country --</option>
              @foreach($countries as $country)
                <option value="{{ $country->id }}">{{ $country->name }}</option>
              @endforeach
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">States</label>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-muted">Tap checkboxes to select states</small>
              <div>
                <button id="selectAll" type="button" class="btn btn-sm btn-outline-secondary">Select all</button>
                <button id="clearAll"  type="button" class="btn btn-sm btn-outline-secondary">Clear</button>
              </div>
            </div>

            <div id="statesContainer" class="border rounded p-2" style="max-height:220px; overflow:auto;">
              <div class="text-muted">Select a country to load states.</div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button id="saveBtn" type="button" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
@endsection

@section('scripts')
<script>
document.addEventListener('DOMContentLoaded', function () {
  const openBtn = document.getElementById('openModalBtn');
  const countryEl = document.getElementById('country');
  const statesContainer = document.getElementById('statesContainer');
  const selectAllBtn = document.getElementById('selectAll');
  const clearAllBtn = document.getElementById('clearAll');
  const saveBtn = document.getElementById('saveBtn');
  const alerts = document.getElementById('alerts');

  const modalEl = document.getElementById('locationModal');
  const bsModal = new bootstrap.Modal(modalEl);

  function showAlert(html, type = 'success') {
    alerts.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
      ${html}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
  }

  openBtn.addEventListener('click', () => {
    // clear alerts inside modal
    statesContainer.innerHTML = '<div class="text-muted">Select a country to load states.</div>';
    bsModal.show();
  });

  countryEl.addEventListener('change', async () => {
    const countryId = countryEl.value;
    statesContainer.innerHTML = '<div class="text-muted">Loading states</div>';
    if (!countryId) {
      statesContainer.innerHTML = '<div class="text-muted">Select a country to load states.</div>';
      return;
    }

    try {
      const res = await fetch("{{ url('') }}/locations/states/" + encodeURIComponent(countryId), {
        headers: { 'Accept': 'application/json' }
      });
      if (!res.ok) throw new Error('Network response was not ok');

      const states = await res.json(); // array of {id, name}
      if (!states.length) {
        statesContainer.innerHTML = '<div class="text-muted">No states for this country.</div>';
        return;
      }

      // render checkboxes
      statesContainer.innerHTML = '';
      states.forEach(s => {
        const id = 'state_' + s.id;
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
          <input class="form-check-input" type="checkbox" value="${s.id}" id="${id}" name="state_ids[]">
          <label class="form-check-label" for="${id}">${escapeHtml(s.name)}</label>
        `;
        statesContainer.appendChild(div);
      });

    } catch (err) {
      console.error(err);
      statesContainer.innerHTML = '<div class="text-danger">Failed to load states  try again.</div>';
    }
  });

  selectAllBtn.addEventListener('click', () => {
    statesContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
  });
  clearAllBtn.addEventListener('click', () => {
    statesContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  });

  saveBtn.addEventListener('click', async () => {
    const countryId = countryEl.value;
    const checked = Array.from(statesContainer.querySelectorAll('input[type="checkbox"]:checked'))
                         .map(cb => cb.value);

    if (!countryId) {
      showAlert('Please select a country.', 'danger'); return;
    }
    if (!checked.length) {
      showAlert('Please select at least one state.', 'danger'); return;
    }

    // Build form data including CSRF token
    const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '{{ csrf_token() }}';
    const formData = new FormData();
    formData.append('country_id', countryId);
    checked.forEach(id => formData.append('state_ids[]', id));
    formData.append('_token', token);

    try {
      const res = await fetch("{{ route('locations.save') }}", {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'application/json' }
      });

      if (res.status === 422) {
        const json = await res.json();
        const firstErr = Object.values(json.errors)[0][0];
        showAlert(firstErr, 'danger');
        return;
      }
      if (!res.ok) throw new Error('Network error');

      const json = await res.json();
      showAlert(json.message ?? 'Saved successfully.', 'success');
      bsModal.hide();
    } catch (err) {
      console.error(err);
      showAlert('Save failed  try again.', 'danger');
    }
  });

  function escapeHtml(str) {
    return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
  }
});
</script>
@endsection
```

---

# 4) Models & DB

* `countries` table: `id`, `name`, ...
* `states` table: `id`, `country_id`, `name`, ...
* `State` model should have `country()` belongsTo and `Country` model can have `states()` hasMany.

Example `State` model snippet:

```php
class State extends Model
{
    public function country()
    {
        return $this->belongsTo(Country::class);
    }
}
```

---

# 5) Notes & tips

* I used vanilla JS `fetch` returning JSON; this works with Laravel default CSRF token if you include the token (I used Blade `csrf_token()` fallback).
* If you prefer jQuery or Select2 for nicer multi-select UX, I can convert the client code.
* Adapt the controller `save()` to persist the selection to whichever model/table you need (user settings, pivot table, etc.). If you want, I can show `sync()` example for a `belongsToMany`.
* If states list is large, consider server-side search (AJAX endpoint that accepts a `q` query).

---

Want me to:

* Add `belongsToMany` save example with migrations and `sync()`?
* Show how to prefill the modal for editing previously-saved selections?
* Convert the checkboxes to a searchable list?









**********************************************************************************************************************
**********************************************************************************************************************
**********************************************************************************************************************

@extends('layouts.app')

@section('content')
<div class="container">
  <button id="openModalBtn" class="btn btn-primary">Choose Country & States</button>

  <!-- Bootstrap Modal -->
  <div class="modal fade" id="locationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="locationForm" action="{{ route('locations.save') }}" method="POST">
        @csrf
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Select Country & States</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="country" class="form-label">Country</label>
              <select id="country" name="country_id" class="form-select" required>
                <option value="">-- Select country --</option>
                @foreach($countries as $country)
                  <option value="{{ $country->id }}">{{ $country->name }}</option>
                @endforeach
              </select>
            </div>

            <div class="mb-3">
              <label for="states" class="form-label">States (select multiple)</label>
              <select id="states" name="state_ids[]" class="form-select" multiple="multiple" style="width:100%" required>
                <!-- options injected by JS -->
              </select>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
@endsection

@section('scripts')
<!-- include jQuery, Bootstrap JS and optionally Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(function() {
  // init select2 on states for multi-select UX
  $('#states').select2({
    placeholder: 'Select states',
    width: 'resolve' // keeps style from css above
  });

  // open modal on click
  $('#openModalBtn').on('click', function() {
    var modal = new bootstrap.Modal(document.getElementById('locationModal'));
    modal.show();
  });

  // when country changes, fetch states
  $('#country').on('change', function() {
    var countryId = $(this).val();
    $('#states').empty().trigger('change'); // clear current options
    if (!countryId) return;

    $.ajax({
      url: '{{ url('') }}/states/' + countryId, // or use route('locations.states', ...)
      type: 'GET',
      success: function(states) {
        // states expected as [{id, name}, ...]
        states.forEach(function(s) {
          var option = new Option(s.name, s.id, false, false);
          $('#states').append(option);
        });
        $('#states').trigger('change');
      },
      error: function() {
        alert('Failed to load states for the selected country.');
      }
    });
  });

  // Optional: if you want to preselect values, you can set them here
  // $('#country').val(1).trigger('change'); then set states after AJAX completes
});
</script>
@endsection






namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\Country;
use App\Models\State;

class LocationController extends Controller
{
    // Return JSON states for given country id
    public function states($countryId)
    {
        $states = State::where('country_id', $countryId)->select('id', 'name')->get();
        return response()->json($states);
    }

    // Save the selection
    public function saveSelection(Request $request)
    {
        $data = $request->validate([
            'country_id' => 'required|exists:countries,id',
            'state_ids'  => 'required|array',
            'state_ids.*'=> 'exists:states,id'
        ]);

        // Example: attach to user or save in DB
        // auth()->user()->update(['country_id' => $data['country_id']]);
        // sync states depending on your model

        return redirect()->back()->with('success', 'Selection saved.');
    }
}




use App\Http\Controllers\LocationController;

Route::get('/states/{country}', [LocationController::class, 'states'])->name('locations.states');
Route::post('/save-selection', [LocationController::class, 'saveSelection'])->name('locations.save');
