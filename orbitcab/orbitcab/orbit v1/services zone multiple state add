Great — here’s a **complete, copy-pasteable implementation** that does everything you asked:

* Add / update selected states (store **only the state IDs** as a JSON array in `cab_zones.states_id`)
* Return the saved list from the server
* Show selected state **names** in the table row (listing the selected values)
* Support prefill (when opening the modal) and update in-place

I'll give you: migration, model, routes, controllers, and a single Blade file (table + modal + JS). Drop these into your project and they should work together (adjust namespaces or paths if yours differ).

---

## 1) Migration — add `states_id` JSON to `cab_zones`

Create migration:

```bash
php artisan make:migration add_states_id_to_cab_zones_table --table=cab_zones
```

Paste into migration file:

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class AddStatesIdToCabZonesTable extends Migration
{
    public function up()
    {
        Schema::table('cab_zones', function (Blueprint $table) {
            if (! Schema::hasColumn('cab_zones', 'states_id')) {
                $table->json('states_id')->nullable()->after('service_zone_id');
            }
        });
    }

    public function down()
    {
        Schema::table('cab_zones', function (Blueprint $table) {
            if (Schema::hasColumn('cab_zones', 'states_id')) {
                $table->dropColumn('states_id');
            }
        });
    }
}
```

Run:

```
php artisan migrate
```

---

## 2) Model — `CabZone` cast (so `states_id` is array in PHP)

`app/Models/CabZone.php`:

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class CabZone extends Model
{
    protected $table = 'cab_zones';

    // So Eloquent returns states_id as PHP array
    protected $casts = [
        'states_id' => 'array',
    ];

    // Optional: relation to states if you want to use it elsewhere
    public function statesRelation()
    {
        return $this->belongsToMany(
            \App\Models\State::class,
            'cab_zone_state', // if you later use pivot
            'cab_zone_id',
            'state_id'
        );
    }
}
```

---

## 3) Routes

Add these to `routes/web.php` (web for CSRF):

```php
use App\Http\Controllers\LocationController;
use App\Http\Controllers\CabZoneController;

// Frontend AJAX: countries & states
Route::get('/api/countries', [LocationController::class, 'countries']);
Route::get('/api/countries/{country}/states', [LocationController::class, 'statesByCountry']);

// Get saved states for a given service-zone uuid (prefill modal)
Route::get('/admin/service-zones/{uuid}/states', [CabZoneController::class, 'getStatesForZone']);

// Save states (add/update) — stores ONLY state IDs array in cab_zones.states_id
Route::post('/ajax/save-states', [CabZoneController::class, 'saveStates'])->name('ajax.save-states');
```

---

## 4) Controllers

### `LocationController` (countries & states)

`app/Http/Controllers/LocationController.php`:

```php
<?php

namespace App\Http\Controllers;

use App\Models\Country;
use App\Models\State;
use Illuminate\Http\Request;

class LocationController extends Controller
{
    public function countries()
    {
        // returns [{id, name}, ...]
        $countries = Country::select('id','name')->orderBy('name')->get();
        return response()->json($countries);
    }

    public function statesByCountry($countryId)
    {
        // returns [{id, name}, ...]
        $states = State::where('country_id', $countryId)->select('id','name')->orderBy('name')->get();
        return response()->json($states);
    }
}
```

### `CabZoneController` (get prefills + save)

`app/Http/Controllers/CabZoneController.php`:

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;
use App\Models\CabZone;
use App\Models\State;

class CabZoneController extends Controller
{
    /**
     * Return saved country_id and states for prefill (modal)
     * Response:
     * {
     *   country_id: int|null,
     *   states_id: [id,id,...],
     *   states: [{id,name}, ...]
     * }
     */
    public function getStatesForZone($uuid)
    {
        // Find service_zone id by uuid
        $svc = \DB::table('service_zone_cities')->where('uuid', $uuid)->first();
        if (!$svc) {
            return response()->json(['message' => 'Service zone not found'], 404);
        }
        $serviceZoneId = $svc->id;

        // Find related cab_zone row (may or may not exist)
        $cabZone = CabZone::where('service_zone_id', $serviceZoneId)->first();

        $statesId = [];
        if ($cabZone && $cabZone->states_id) {
            $statesId = $cabZone->states_id;
        }

        // If service_zone_cities has country_id, return it (attempt)
        $countryId = $svc->country_id ?? null;

        // Provide state objects for display (names)
        $states = [];
        if (!empty($statesId)) {
            $states = State::whereIn('id', $statesId)->select('id','name')->orderBy('name')->get();
        }

        return response()->json([
            'country_id' => $countryId,
            'states_id' => $statesId,
            'states' => $states,
        ]);
    }

    /**
     * Save states (store only integer IDs in cab_zones.states_id as JSON array)
     * Request:
     * - service_zone_id (uuid)
     * - states (array ints)
     *
     * Response:
     * {
     *   success: true,
     *   cab_zone_id: int,
     *   states_id: [4002,4003,...],
     *   states: [{id,name},...],
     *   state_count: int
     * }
     */
    public function saveStates(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'service_zone_id' => 'required|string',
            'states' => 'nullable|array',
            'states.*' => 'integer|exists:states,id',
        ]);

        if ($validator->fails()) {
            return response()->json([
                'success' => false,
                'message' => 'Validation failed',
                'errors' => $validator->errors()
            ], 422);
        }

        $uuid = $request->input('service_zone_id');
        $stateIds = $request->input('states', []);

        // sanitize: ints, positive, unique
        $stateIds = array_values(array_unique(array_map('intval', array_filter($stateIds, function($v) {
            return is_numeric($v) && intval($v) > 0;
        }))));

        // convert uuid -> service_zone_cities.id
        $svc = \DB::table('service_zone_cities')->where('uuid', $uuid)->first();
        if (!$svc) {
            return response()->json(['success' => false, 'message' => 'Service zone not found'], 404);
        }
        $serviceZoneId = $svc->id;

        // find or create cab_zone row
        $cabZone = CabZone::firstOrCreate(['service_zone_id' => $serviceZoneId]);

        // Save only IDs (Eloquent cast will handle JSON)
        $cabZone->states_id = $stateIds;
        $cabZone->save();

        // prepare states objects to return
        $states = [];
        if (!empty($stateIds)) {
            $states = State::whereIn('id', $stateIds)->select('id','name')->orderBy('name')->get();
        }

        return response()->json([
            'success' => true,
            'cab_zone_id' => $cabZone->id,
            'states_id' => $cabZone->states_id,
            'states' => $states,
            'state_count' => count($cabZone->states_id ?? [])
        ]);
    }
}
```

---

## 5) Blade — full page (table, modal, JS).

Place this in the Blade view that renders `$zones` and `$countries`. It assumes `$zones` contains service-zone rows and `$countries` is an array of countries (you can also fetch countries via AJAX).

**Important:** this Blade uses Bootstrap 4/5 jQuery modal markup (your project already has Bootstrap/jQuery). Adjust only if different.

```blade
@extends('layouts.app', ['isSidebar' => true, 'isNavbar' => true, 'isFooter' => false])

@push('styles')
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
@endpush

@section('content')
<div class="content-header row top_header">
    <h4 class="py-2 mb-0"><span class="text-muted fw-light">City Services Zone List</span></h4>
    <div class="d-flex align-content-center flex-wrap gap-3">
        <a href="{{ route('admin.service-zones.create') }}" class="btn btn-primary">Add Service City</a>
    </div>
</div>

<div class="content-body">
    <section id="row-selection">
        <div class="card">
            <div class="card-body">
                <table class="table table-striped table-bordered" id="zonesTable">
                    <thead>
                        <tr>
                            <th>Sr. No.</th>
                            <th>City</th>
                            <th>Selected States</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach ($zones as $key => $valu)
                        @php
                            // Get display names for selected states (if cabZone exists)
                            $cabzone = $valu->cabZone->first() ?? null;
                            $selectedStates = [];
                            if ($cabzone && $cabzone->states_id) {
                                // states_id is stored as json array; use helper or eager load to avoid N+1
                                $selectedStates = \App\Models\State::whereIn('id', $cabzone->states_id)->pluck('name')->toArray();
                            }
                        @endphp
                        <tr data-uuid="{{ $valu->uuid }}">
                            <td>{{ $key + 1 }}</td>
                            <td>{{ $valu->city?->name ?? '-' }}</td>
                            <td class="selected-states-cell">
                                @if(!empty($selectedStates))
                                    {{ implode(', ', $selectedStates) }}
                                @else
                                    <span class="text-muted">No states selected</span>
                                @endif
                            </td>
                            <td>
                                @if($valu->status == 1)
                                    <a href="#" class="btn btn-sm btn-primary addStateBtn"
                                       data-uuid="{{ $valu->uuid }}"
                                       data-country-id="{{ $valu->country_id ?? '' }}">
                                       <i class="fas fa-plus-circle"></i> Edit States
                                    </a>
                                @else
                                    <button class="btn btn-sm btn-secondary" disabled>Inactive</button>
                                @endif
                            </td>
                        </tr>
                    @endforeach
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<!-- Modal -->
<div class="modal fade" id="addStateModal" tabindex="-1" role="dialog" aria-labelledby="addStateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <form id="addStateModalForm" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title" id="addStateModalLabel">Select States</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="modal_service_zone_uuid" />

            <div class="form-group">
                <label for="countrySelect">Country</label>
                <select id="countrySelect" class="form-control">
                    <option value="">-- Select Country --</option>
                    @foreach ($countries as $c)
                        <option value="{{ $c->id }}">{{ $c->name }}</option>
                    @endforeach
                </select>
            </div>

            <div class="form-group">
                <label>States</label>
                <div id="stateContainer" style="max-height:300px; overflow:auto; border:1px solid #eee; padding:8px; border-radius:4px;">
                    <p class="text-muted">Select a country to load states</p>
                </div>
            </div>

            <div id="addStateError" class="text-danger small d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" id="saveStates" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>

@endsection

@push('scripts')
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Make sure CSRF is available for AJAX
$.ajaxSetup({
    headers: { 'X-CSRF-TOKEN': '{{ csrf_token() }}' }
});

$(function() {
    const baseUrl = window.baseUrl || '/';

    // Open modal and load preselected states
    $(document).on('click', '.addStateBtn', function(e) {
        e.preventDefault();
        $('#addStateError').addClass('d-none').text('');
        const uuid = $(this).data('uuid');
        const initialCountryId = $(this).data('country-id') || '';

        $('#modal_service_zone_uuid').val(uuid);
        if (initialCountryId) {
            $('#countrySelect').val(initialCountryId);
        } else {
            $('#countrySelect').val('');
        }

        // show loading
        $('#stateContainer').html('<p class="text-muted small">Loading selected states...</p>');

        // Prefill: get existing saved states for this uuid
        $.get('/admin/service-zones/' + uuid + '/states')
            .done(function(res) {
                const countryId = res.country_id || initialCountryId || '';
                $('#countrySelect').val(countryId);
                loadStates(countryId, res.states_id || []);
                $('#addStateModal').modal('show');
            })
            .fail(function() {
                if (initialCountryId) {
                    loadStates(initialCountryId, []);
                } else {
                    $('#stateContainer').html('<p class="text-muted small">Select a country to load states.</p>');
                }
                $('#addStateModal').modal('show');
            });
    });

    // when country changes
    $('#countrySelect').on('change', function() {
        const cid = $(this).val();
        if (!cid) {
            $('#stateContainer').html('<p class="text-muted small">Select a country to load states.</p>');
            return;
        }
        loadStates(cid, []);
    });

    // Load states for country and pre-check ids
    function loadStates(countryId, preSelectedIds = []) {
        $('#stateContainer').html('<p class="text-muted small">Loading states...</p>');

        $.get(baseUrl + 'api/countries/' + countryId + '/states')
            .done(function(list) {
                if (!Array.isArray(list) || list.length === 0) {
                    $('#stateContainer').html('<p class="text-muted small">No states found for this country.</p>');
                    return;
                }
                let html = '<div class="list-group">';
                list.forEach(function(s) {
                    const checked = (preSelectedIds && preSelectedIds.indexOf(s.id) !== -1) ? 'checked' : '';
                    html += `<label class="list-group-item">
                                <input type="checkbox" class="state-checkbox me-2" value="${s.id}" ${checked}>
                                ${s.name}
                             </label>`;
                });
                html += '</div>';
                $('#stateContainer').html(html);
            })
            .fail(function(xhr) {
                console.error('Error loading states', xhr.responseText || xhr.statusText);
                $('#stateContainer').html('<div class="text-danger small">Failed to load states. Try again.</div>');
            });
    }

    // Save selected states (store only IDs)
    $('#saveStates').on('click', function(e) {
        e.preventDefault();
        $('#addStateError').addClass('d-none').text('');
        const uuid = $('#modal_service_zone_uuid').val();
        if (!uuid) {
            $('#addStateError').removeClass('d-none').text('Invalid service zone. Close and reopen modal.');
            return;
        }

        // collect selected ids and dedupe
        const selected = [];
        $('#stateContainer').find('.state-checkbox:checked').each(function() {
            const v = parseInt($(this).val(), 10);
            if (!isNaN(v) && v > 0) selected.push(v);
        });
        const uniq = Array.from(new Set(selected));

        // send to server
        const payload = {
            service_zone_id: uuid,
            states: uniq
        };

        const $btn = $(this);
        $btn.prop('disabled', true).text('Saving...');

        $.post(baseUrl + 'ajax/save-states', payload)
            .done(function(resp) {
                if (resp.success) {
                    // update table cell: show names (server returned 'states' array)
                    const $row = $(`tr[data-uuid="${uuid}"]`);
                    if (resp.states && resp.states.length > 0) {
                        const names = resp.states.map(s => s.name).join(', ');
                        $row.find('.selected-states-cell').text(names);
                    } else {
                        $row.find('.selected-states-cell').html('<span class="text-muted">No states selected</span>');
                    }

                    $('#addStateModal').modal('hide');
                } else {
                    $('#addStateError').removeClass('d-none').text(resp.message || 'Save failed');
                }
            })
            .fail(function(xhr) {
                let msg = 'Error saving states.';
                if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
                $('#addStateError').removeClass('d-none').text(msg);
            })
            .always(function() {
                $btn.prop('disabled', false).text('Save');
            });
    });

    // optional: initialize datatable
    $('#zonesTable').DataTable && $('#zonesTable').DataTable();

    // cleanup modal on close
    $('#addStateModal').on('hidden.bs.modal', function () {
        $('#modal_service_zone_uuid').val('');
        $('#stateContainer').html('<p class="text-muted small">Select a country to load states.</p>');
        $('#addStateError').addClass('d-none').text('');
    });
});
</script>
@endpush
```

---

## 6) Notes & small tips

* The controller stores only the IDs in `cab_zones.states_id` (JSON). Example DB cell content:

  ```
  [4002,4003,4005,4006]
  ```
* The controller responds with `states` array (objects) so the frontend updates text with names.
* If you prefer to fetch countries via AJAX instead of preloading `$countries` in the Blade, remove the server-side `@foreach` and call `/api/countries` from JS — both will work.
* Performance: If you have many rows, it's better to eager-load related cabZone to avoid N+1. Example in controller that serves the Blade view:

  ```php
  $zones = ServiceZoneCity::with('cabZone')->get();
  ```

  and ensure `cabZone()` relation returns the cab_zones records.

---

If you want, I can now:

* produce a small migration to **backfill** `states_id` from any existing pivot table or legacy column, or
* convert the checkbox UI into a searchable **Select2 multi-select** (better when the list is long).

Which one shall I add next?













@extends('layouts.app', ['isSidebar' => true, 'isNavbar' => true, 'isFooter' => false])

@push('styles')
    <link rel="stylesheet" href="{{ asset('app-assets/vendors/css/forms/icheck/icheck.css') }}">
    <link rel="stylesheet" href="{{ asset('app-assets/vendors/css/forms/toggle/bootstrap-switch.min.css') }}">
    <link rel="stylesheet" href="{{ asset('app-assets/vendors/css/forms/toggle/switchery.min.css') }}">
    <link rel="stylesheet" href="{{ asset('app-assets/css/plugins/forms/switch.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/vendor/datatables/responsive.bootstrap4.min.css') }}">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
@endpush

@section('content')
    <div class="content-header row top_header">
        <h4 class="py-2 mb-0"><span class="text-muted fw-light">{{ __('City Services Zone List') }}</span></h4>
        <div class="d-flex align-content-center flex-wrap gap-3">
            <a href="{{ route('admin.service-zones.create') }}" class="btn btn-primary">{{ __('Add Service City') }}</a>
            {{-- <button class="btn btn-secondary" data-toggle="modal"
                data-target="#addStateModal">{{ __('Add State') }}</button> --}}
        </div>
    </div>

    <div class="content-body">
        <section id="row-selection">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <a class="heading-elements-toggle"><i class="fa fa-ellipsis-v font-medium-3"></i></a>
                            <div class="heading-elements">
                                <ul class="list-inline mb-0">
                                    <li><a data-action="collapse"><i class="ft-minus"></i></a></li>
                                    <li><a data-action="reload"><i class="ft-rotate-cw"></i></a></li>
                                    <li><a data-action="expand"><i class="ft-maximize"></i></a></li>
                                    <li><a data-action="close"><i class="ft-x"></i></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="card-content collapse show">
                            <div class="card-body">
                                <table class="table table-striped table-bordered customdatatable" id="carTooable">
                                    <thead>
                                        <tr>
                                            <th>{{ __('Sr. No.') }}</th>
                                            <th>{{ __('State Name') }}</th>
                                            <th>{{ __('Service Area') }}</th>
                                            <th>{{ __('Action') }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach ($zones as $key => $valu)
                                            <tr>
                                                <td>{{ $key + 1 }}</td>
                                                <input type="hidden" class="serviceZoneId" id="serviceZoneId"
                                                    value="{{ $valu?->uuid }}">
                                                {{-- @dd($valu) --}}
                                                @php
                                                    $cabezones = $valu?->cabZone->first();
                                                @endphp
                                                <td>
                                                    @if (isset($cabezones) && isset($cabezones->states_id) && $cabezones->states_id !== null)
                                                        {{ findState($cabezones->states_id, 'name') }}
                                                    @else
                                                        {{ $valu->state?->name }}
                                                    @endif
                                                    @if ($valu->status == 1 && $valu?->id !== null && $valu?->city?->id !== null)
                                                        @if (!$valu->cabZone->first())
                                                            <div class="text-right">
                                                                <a href="#" class="btn btn-sm btn-primary disabled"
                                                                    data-toggle="modal" data-target="#addStateModal">
                                                                    <i class="fas fa-plus-circle"></i>
                                                                </a>
                                                            </div>
                                                        @else
                                                            <div class="text-right">
                                                                <a href="#" class="btn btn-sm btn-primary addStateBtn"
                                                                    data-toggle="modal" data-uuid="{{ $valu->uuid }}"
                                                                    data-target="#addStateModal">
                                                                    <i class="fas fa-plus-circle"></i>
                                                                </a>
                                                            </div>
                                                        @endif
                                                    @else
                                                        <div class="text-right">
                                                            <a href="#" class="btn btn-sm btn-primary disabled"
                                                                data-toggle="modal" data-target="#addStateModal">
                                                                <i class="fas fa-plus-circle"></i>
                                                            </a>
                                                        </div>
                                                    @endif
                                                </td>
                                                <td>
                                                    @if ($valu->status == 1 && $valu?->id !== null && $valu?->city?->id !== null)
                                                        @if (!$valu->cabZone->first())
                                                            <a href="{{ route('admin.service-zones.editPolygonDraw', [$valu?->id, $valu?->city->id]) }}"
                                                                class="btn btn-primary">
                                                                <i class="fa-solid fa-draw-polygon"></i> Add Service Area
                                                            </a>
                                                        @endif
                                                        @if ($valu->cabZone->first())
                                                            <a href="{{ route('admin.service-zones.viewPolygonDraw', [$valu->id, $valu->city->id]) }}"
                                                                class="btn btn-secondary">
                                                                <i class="fa-solid fa-street-view"></i> View
                                                            </a>
                                                        @endif
                                                        @if ($valu->cabZone->first())
                                                            <a class="btn btn-danger deleteData"
                                                                data-uuid="{{ $valu->cabZone->first()->uuid }}"
                                                                href="javascript:void(0)" data-table="cab_zones">
                                                                <i class="fa-solid fa-trash"></i> Delete
                                                            </a>
                                                        @endif
                                                    @else
                                                        @if (!$valu->cabZone->first())
                                                            <button class="btn btn-secondary" disabled>
                                                                <i class="fa-solid fa-draw-polygon"></i> Add Service Area
                                                            </button>
                                                        @else
                                                            <button class="btn btn-secondary" disabled>
                                                                <i class="fa-solid fa-street-view"></i> View
                                                            </button>
                                                            <button class="btn btn-danger" disabled>
                                                                <i class="fa-solid fa-trash"></i> Delete
                                                            </button>
                                                        @endif
                                                    @endif
                                                </td>
                                                <td>
                                                    <div class="">
                                                        <label class="switch">
                                                            <input type="checkbox" class="changeStatus"
                                                                id="switchery_inline{{ $valu->uuid }}" name="is_active"
                                                                {{ $valu->status ? 'checked' : '' }}
                                                                data-uuid="{{ $valu->uuid }}"
                                                                data-table="service_zone_cities" data-message="deactive">
                                                            <span class="slider round"></span>
                                                        </label>
                                                        <a class="deleteData" href="javascript:void(0)"
                                                            data-table="service_zone_cities"
                                                            data-uuid="{{ $valu->uuid }}"> <span
                                                                style="margin-right: 5px;"><i
                                                                    class="fa-solid fa-trash"></i></span>Delete</a>
                                                    </div>
                                                </td>
                                            </tr>
                                        @endforeach
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
        </section>
    </div>

    <!-- Modal for Add State -->
    <div class="modal fade" id="addStateModal" tabindex="-1" role="dialog" aria-labelledby="addStateModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStateModalLabel">{{ __('Add State') }}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="countrySelect">{{ __('Select Country') }}</label>
                        <select id="countrySelect" class="form-control">
                            <option value="">{{ __('Select Country') }}</option>
                            @foreach ($countries as $country)
                                <option value="{{ $country->id }}" {{ $country->id == 101 ? 'selected' : '' }}>
                                    {{ $country->name }}
                                </option>
                            @endforeach
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="stateSelect">{{ __('Select States') }}</label>
                        <select id="stateSelect" class="form-control" multiple>
                            <!-- States will be populated based on selected country -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ __('Close') }}</button>
                    <button type="button" class="btn btn-primary" id="saveStates">{{ __('Save States') }}</button>
                </div>
            </div>
        </div>
    </div>
@endsection

@push('scripts')
    <script src="{{ asset('app-assets/vendors/js/forms/icheck/icheck.min.js') }}"></script>
    <script src="{{ asset('app-assets/vendors/js/forms/toggle/bootstrap-switch.min.js') }}"></script>
    <script src="{{ asset('app-assets/vendors/js/forms/toggle/switchery.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/dataTables.bootstrap4.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/dataTables.responsive.min.js') }}"></script>
    <script src="{{ asset('assets/vendor/datatables/responsive.bootstrap4.min.js') }}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.flash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{{ asset('assets/custom/js/datatableajax.js') }}"></script>

    <script>
        $(document).ready(function() {

                // Handle "Add State" button click
                $('.addStateBtn').on('click', function(event) {
                    resetAddStateModal();
                });

                // Handle country dropdown change
                $('#countrySelect').change(function() {
                    var countryId = $(this).val();
                    loadStatesForCountry(countryId);
                });

                // Handle "Save States" button click
                $('#saveStates').click(function() {
                    saveSelectedStates();
                });

                // Clear modal when it's hidden
                $('#addStateModal').on('hidden.bs.modal', function() {
                    clearAddStateModal();
                });
            });

            function resetAddStateModal() {
                // Reset the country dropdown
                $('#countrySelect').val('').trigger('change');

                // Clear all state checkboxes
                $('#stateSelect').empty();

                // Reset any error messages if present
                $('.state-error').remove();

                // Also reset the form if it's inside a form element
                $('#addStateModal form')[0]?.reset();
            }

            function loadStatesForCountry(countryId) {
                var stateCheckboxes = $('#stateSelect');

                // Clear previous checkboxes and any error messages
                stateCheckboxes.empty();
                $('.state-error').remove();

                if (countryId) {
                    $.ajax({
                        url: baseUrl + 'ajax/states/' + countryId,
                        method: 'GET',
                        success: function(data) {
                            if (data.length > 0) {
                                $.each(data, function(index, state) {
                                    stateCheckboxes.append(
                                        '<div class="form-check">' +
                                        '<input class="form-check-input" type="checkbox" value="' +
                                        state.id + '" id="state' + state.id + '">' +
                                        '<label class="form-check-label" for="state' +
                                        state.id + '">' + state.name + '</label>' +
                                        '</div>'
                                    );
                                });
                            } else {
                                stateCheckboxes.append(
                                    '<div class="alert alert-warning state-error">No states found for this country.</div>'
                                );
                            }
                        },
                        error: function(xhr) {
                            console.error(xhr.responseText);
                            stateCheckboxes.append(
                                '<div class="alert alert-danger state-error">Error loading states. Please try again.</div>'
                            );
                        }
                    });
                } else {
                    stateCheckboxes.append(
                        '<div class="text-muted state-error">Please select a country first.</div>'
                    );
                }
            }

            function saveSelectedStates() {
                var selectedStates = [];
                var modal = $('#addStateModal');
                var serviceZoneId = modal.data('serviceZoneId');

                // If service zone ID is not found in the modal, try to get it from the last clicked button
                if (!serviceZoneId) {
                    serviceZoneId = $('.addStateBtn').data('uuid');
                }

                console.log("Service Zone ID:", serviceZoneId);

                $('#stateSelect input:checked').each(function() {
                    selectedStates.push($(this).val());
                });

                if (selectedStates.length > 0 && serviceZoneId) {
                    $.ajax({
                        url: baseUrl + 'ajax/save-states',
                        method: 'POST',
                        data: {
                            states: selectedStates,
                            service_zone_id: serviceZoneId,
                            _token: '{{ csrf_token() }}'
                        },
                        success: function(response) {
                            console.log(response);
                            showToast('States added successfully!', 'success');
                        },
                        error: function(xhr) {
                            console.error(xhr.responseText);
                            showToast('Error saving states. Please try again.', 'error');
                        }
                    });
                } else if (!serviceZoneId) {
                    showToast('Error: No service zone ID found. Please open the modal again.', 'error');
                } else {
                    showToast('Please select at least one state.', 'warning');
                }
            }

            function clearAddStateModal() {
                // Reset form if exists
                $('#addStateModal form')[0]?.reset();

                // Clear all state checkboxes
                $('#stateSelect').empty();

                // Reset country dropdown
                $('#countrySelect').val('').trigger('change');

                // Clear service zone ID
                $('#serviceZoneId').val('');
            }

            function showToast(message, type = 'info') {
                // You can implement your toast notification here
                // Example with Bootstrap toast if available
                console.log(type.toUpperCase() + ': ' + message);
            }







            // $('.addStateBtn').on('click', function(event) {
            //     var button = $(event.relatedTarget);

            //     // Reset the country dropdown
            //     $('#countrySelect').val('').trigger('change');

            //     // Clear all state checkboxes
            //     $('#stateSelect').empty();

            //     // Reset any error messages if present
            //     $('.state-error').remove();

            //     // Also reset the form if it's inside a form element
            //     $('#addStateModal form')[0]?.reset();

            // });

            // $('#countrySelect').change(function() {
            //     var countryId = $(this).val();
            //     var stateCheckboxes = $('#stateSelect');

            //     // Clear previous checkboxes and any error messages
            //     stateCheckboxes.empty();
            //     $('.state-error').remove();

            //     if (countryId) {
            //         $.ajax({
            //             url: baseUrl + 'ajax/states/' + countryId,
            //             method: 'GET',
            //             success: function(data) {
            //                 if (data.length > 0) {
            //                     $.each(data, function(index, state) {
            //                         stateCheckboxes.append(
            //                             '<div class="form-check">' +
            //                             '<input class="form-check-input" type="checkbox" value="' +
            //                             state.id + '" id="state' + state.id + '">' +
            //                             '<label class="form-check-label" for="state' +
            //                             state.id + '">' + state.name + '</label>' +
            //                             '</div>'
            //                         );
            //                     });
            //                 } else {
            //                     stateCheckboxes.append(
            //                         '<div class="alert alert-warning state-error">No states found for this country.</div>'
            //                     );
            //                 }
            //             },
            //             error: function(xhr) {
            //                 console.error(xhr.responseText);
            //                 stateCheckboxes.append(
            //                     '<div class="alert alert-danger state-error">Error loading states. Please try again.</div>'
            //                 );
            //             }
            //         });
            //     } else {
            //         stateCheckboxes.append(
            //             '<div class="text-muted state-error">Please select a country first.</div>'
            //         );
            //     }
            // });


            // $('#saveStates').click(function() {
            //     var selectedStates = [];

            //     // Get the modal instance and find which button opened it
            //     var modal = $('#addStateModal');
            //     var serviceZoneId = null;

            //     // Try to get from modal data first
            //     serviceZoneId = modal.data('serviceZoneId');

            //     // If not found, try to get from the last clicked button
            //     if (!serviceZoneId) {
            //         // This assumes you're tracking the last clicked button
            //         serviceZoneId = $('.addStateBtn').last().data('uuid');
            //     }

            //     console.log("Service Zone ID:", serviceZoneId);

            //     $('#stateSelect input:checked').each(function() {
            //         selectedStates.push($(this).val());
            //     });

            //     if (selectedStates.length > 0 && serviceZoneId) {
            //         $.ajax({
            //             url: baseUrl + 'ajax/save-states',
            //             method: 'POST',
            //             data: {
            //                 states: selectedStates,
            //                 service_zone_id: serviceZoneId,
            //                 _token: '{{ csrf_token() }}'
            //             },
            //             success: function(response) {
            //                 console.log(response);
            //                 // $('#addStateModal').modal('hide');
            //                 showToast('States added successfully!', 'success');
            //             },
            //             error: function(xhr) {
            //                 console.error(xhr.responseText);
            //                 showToast('Error saving states. Please try again.', 'error');
            //             }
            //         });
            //     } else if (!serviceZoneId) {
            //         alert('Error: No service zone ID found. Please open the modal again.');
            //     } else {
            //         alert('Please select at least one state.');
            //     }
            // });

            // // Optional: Clear form when modal is closed completely
            // $('#addStateModal').on('hidden.bs.modal', function() {
            //     // Reset form if exists
            //     $('#addStateModal form')[0]?.reset();

            //     // Clear all state checkboxes
            //     $('#stateSelect').empty();

            //     // Reset country dropdown
            //     $('#countrySelect').val('').trigger('change');

            //     // Clear service zone ID
            //     $('#serviceZoneId').val('');
            // });

            // // Optional: Toast notification function
            // function showToast(message, type = 'info') {
            //     // You can implement your toast notification here
            //     // Example with Bootstrap toast if available
            //     console.log(type.toUpperCase() + ': ' + message);
            // }
        // });
    </script>
@endpush






 public function saveStates(Request $request)
    {
        // dd($request->all());
        $id = uuidtoid($request->service_zone_id, 'service_zone_cities');
        //    $state=ServiceZoneCity::find($id);
        $state = CabZone::where('service_zone_id', $id)->first();

        // dd($state, $request->state_id);
        $state->states_id = $request->states;
        $state->save();
        // dd($state);
        return response()->json($state);
    }
















@extends('layouts.app', ['isSidebar' => true, 'isNavbar' => true, 'isFooter' => false])

@push('styles')
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
@endpush

@section('content')
<div class="content-header row top_header">
    <h4 class="py-2 mb-0">
        <span class="text-muted fw-light">City Services Zone List</span>
    </h4>
</div>

<div class="content-body">
    <div class="card">
        <div class="card-body">
            <table class="table table-bordered" id="zonesTable">
                <thead>
                    <tr>
                        <th>Sr No</th>
                        <th>City</th>
                        <th>States</th>
                    </tr>
                </thead>
                <tbody>
                @foreach($zones as $k => $z)
                    <tr>
                        <td>{{ $k + 1 }}</td>

                        <td>{{ $z->city?->name }}</td>

                        <td>
                            <span class="state-name">
                                {{-- show number of states selected --}}
                                @php $c = $z->states()->count(); @endphp
                                {{ $c > 0 ? "$c states selected" : "No states selected" }}
                            </span>

                            <span class="badge bg-success ms-1 open-states-modal"
                                  data-uuid="{{ $z->uuid }}"
                                  data-country-id="{{ $z->country_id ?? '' }}"
                                  style="cursor:pointer;">
                                change
                            </span>
                        </td>
                    </tr>
                @endforeach
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- -------------------------- -->
<!--  STATES SELECT MODAL      -->
<!-- -------------------------- -->
<div class="modal fade" id="statesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <form id="statesModalForm">
                <div class="modal-header">
                    <h5 class="modal-title">Select States</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" id="modal_uuid">

                    <div class="mb-3">
                        <label class="form-label">Country</label>
                        <select id="countrySelect" class="form-select">
                            <option value="">Select country</option>
                        </select>
                    </div>

                    <div id="statesContainer" style="max-height:350px; overflow-y:auto;">
                        <p class="text-muted">Select a country to load states...</p>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" id="saveStatesBtn" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>

        </div>
    </div>
</div>


@endsection


@push('scripts')
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<script>
$(function() {
    const modalEl = document.getElementById('statesModal');
    const modal = new bootstrap.Modal(modalEl);

    let currentUuid = null;

    // ------------------------------
    // Load countries
    // ------------------------------
    function loadCountries(selectedId = null) {
        $("#countrySelect").html('<option>Loading...</option>');

        $.get("/api/countries", function(list) {
            let html = '<option value="">Select country</option>';
            list.forEach(c => {
                html += `<option value="${c.id}" ${selectedId == c.id ? 'selected':''}>${c.name}</option>`;
            });
            $("#countrySelect").html(html);
        });
    }

    // ------------------------------
    // Load states by country
    // ------------------------------
    function loadStates(countryId, selectedStateIds = []) {
        $("#statesContainer").html("<p>Loading states...</p>");

        $.get(`/api/countries/${countryId}/states`, function(list) {

            if (list.length === 0) {
                $("#statesContainer").html("<p>No states found.</p>");
                return;
            }

            let html = `<div class="list-group">`;
            list.forEach(s => {
                const chk = selectedStateIds.includes(s.id) ? "checked" : "";
                html += `
                    <label class="list-group-item">
                        <input type="checkbox" class="state-checkbox me-2" value="${s.id}" ${chk}>
                        ${s.name}
                    </label>
                `;
            });
            html += `</div>`;

            $("#statesContainer").html(html);
        });
    }

    // ------------------------------
    // When clicking "change" badge
    // ------------------------------
    $(document).on("click", ".open-states-modal", function() {

        currentUuid = $(this).data("uuid");
        const countryId = $(this).data("country-id") || "";

        $("#modal_uuid").val(currentUuid);

        loadCountries(countryId);

        // Load existing selected states
        $.get(`/admin/service-zones/${currentUuid}/states`, function(res) {

            if (res.country_id) {
                $("#countrySelect").val(res.country_id);
                loadStates(res.country_id, res.state_ids);
            } else if (countryId) {
                $("#countrySelect").val(countryId);
                loadStates(countryId, []);
            } else {
                $("#statesContainer").html(`<p>Select a country...</p>`);
            }

            modal.show();
        });
    });

    // ------------------------------
    // Changing country reloads states
    // ------------------------------
    $("#countrySelect").on("change", function() {
        const id = $(this).val();
        if (id) loadStates(id, []);
        else $("#statesContainer").html("<p>Select a country...</p>");
    });


    // ------------------------------
    // SAVE STATES
    // ------------------------------
    $("#saveStatesBtn").on("click", function() {
        const uuid = $("#modal_uuid").val();

        const selected = [];
        $(".state-checkbox:checked").each(function() {
            selected.push(parseInt($(this).val()));
        });

        $("#saveStatesBtn").prop("disabled", true).text("Saving...");

        $.ajax({
            url: `/admin/service-zones/${uuid}/update-states`,
            type: "PATCH",
            data: {
                states_id: selected,
                _token: "{{ csrf_token() }}"
            },
            success: function(res) {
                modal.hide();
                $("#saveStatesBtn").prop("disabled", false).text("Save");

                // Update row dynamically
                const badge = $(`.open-states-modal[data-uuid="${uuid}"]`);
                const stateNameCell = badge.closest("td").find(".state-name");

                stateNameCell.text(res.count + " states selected");
            },
            error: function() {
                alert("Error saving states.");
                $("#saveStatesBtn").prop("disabled", false).text("Save");
            }
        });

    });

});
</script>
@endpush









// app/Http/Controllers/LocationController.php
namespace App\Http\Controllers;

use App\Models\Country;
use App\Models\State;
use Illuminate\Http\Request;

class LocationController extends Controller
{
    public function countries()
    {
        $countries = Country::select('id','name')->orderBy('name')->get();
        // return minimal JSON
        return response()->json($countries);
    }

    public function statesByCountry($countryId)
    {
        $states = State::where('country_id', $countryId)->select('id','name')->orderBy('name')->get();
        return response()->json($states);
    }
}


// app/Http/Controllers/ServiceZoneController.php
namespace App\Http\Controllers;

use App\Models\ServiceZoneCity;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;

class ServiceZoneController extends Controller
{
    // Return saved country_id and state_ids to prefill the modal
    public function getStatesForZone($uuid)
    {
        $zone = ServiceZoneCity::where('uuid', $uuid)->with('states')->firstOrFail();

        $countryId = $zone->country_id ?? null;
        $stateIds = $zone->states->pluck('id')->toArray();

        // optionally include state objects for display
        $states = $zone->states->map(function($s){
            return ['id' => $s->id, 'name' => $s->name];
        });

        return response()->json([
            'country_id' => $countryId,
            'state_ids' => $stateIds,
            'states' => $states,
        ]);
    }

    // Update selected states (array)
    public function updateStates(Request $request, $uuid)
    {
        $validator = Validator::make($request->all(), [
            'states_id' => 'array',
            'states_id.*' => 'integer|exists:states,id',
        ]);

        if ($validator->fails()) {
            return response()->json(['message' => 'Invalid input', 'errors' => $validator->errors()], 422);
        }

        $zone = ServiceZoneCity::where('uuid', $uuid)->firstOrFail();

        $stateIds = $request->input('states_id', []);

        // sync pivot
        $zone->states()->sync($stateIds);

        return response()->json(['success' => true, 'count' => count($stateIds)]);
    }
}


use App\Http\Controllers\LocationController;
use App\Http\Controllers\ServiceZoneController;

Route::middleware(['auth','admin'])->group(function () {
    // AJAX: countries and states (used by modal)
    Route::get('/api/countries', [LocationController::class, 'countries']);
    Route::get('/api/countries/{country}/states', [LocationController::class, 'statesByCountry']);

    // Get saved states for a service zone (preselect)
    Route::get('/admin/service-zones/{uuid}/states', [ServiceZoneController::class, 'getStatesForZone']);

    // Update selected states for a zone
    Route::patch('/admin/service-zones/{uuid}/update-states', [ServiceZoneController::class, 'updateStates']);
});



















Nice — below is a ready-to-drop-in Laravel example that follows the same idea: a button opens a Bootstrap modal in a Blade view, the country `<select>` is populated from the database, when a country is chosen the states are fetched by AJAX and rendered as **checkboxes**, and the selected values are POSTed to the server and validated.

I'll give you the routes, controller, a simple controller-level implementation (uses `Country` and `State` Eloquent models), and the Blade file with vanilla JS (fetch) so you don't need jQuery.

---

# 1) Routes (`routes/web.php`)

```php
use App\Http\Controllers\LocationController;

Route::get('/locations', [LocationController::class, 'index'])->name('locations.index');
Route::get('/locations/states/{country}', [LocationController::class, 'states'])->name('locations.states');
Route::post('/locations/save', [LocationController::class, 'save'])->name('locations.save');
```

---

# 2) Controller (`app/Http/Controllers/LocationController.php`)

```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\Country;
use App\Models\State;
use Illuminate\Support\Facades\Validator;

class LocationController extends Controller
{
    // Show view with countries
    public function index()
    {
        $countries = Country::select('id', 'name')->orderBy('name')->get();
        return view('locations.index', compact('countries'));
    }

    // Return JSON states for selected country
    public function states($countryId)
    {
        $states = State::where('country_id', $countryId)
                       ->select('id', 'name')
                       ->orderBy('name')
                       ->get();

        return response()->json($states);
    }

    // Save selection (example: store into user meta or a table)
    public function save(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'country_id' => 'required|exists:countries,id',
            'state_ids'  => 'required|array|min:1',
            'state_ids.*'=> 'exists:states,id'
        ]);

        if ($validator->fails()) {
            // if AJAX request, return json, otherwise redirect back with errors
            if ($request->wantsJson() || $request->ajax()) {
                return response()->json(['errors' => $validator->errors()], 422);
            }
            return redirect()->back()->withErrors($validator)->withInput();
        }

        $data = $validator->validated();

        // Example saving: attach to current user (adjust to your app)
        // auth()->user()->update(['country_id' => $data['country_id']]);
        // auth()->user()->states()->sync($data['state_ids']); // if you have a many-to-many

        // for demo we just return success JSON
        return response()->json(['message' => 'Selection saved successfully.']);
    }
}
```

> Note: adapt the saving part to your application's models (e.g. `User::states()` relation or a separate table). The controller returns JSON for AJAX convenience.

---

# 3) Blade view (`resources/views/locations/index.blade.php`)

```blade
@extends('layouts.app')

@section('content')
<div class="container py-4">
  <h1>Choose Country & States</h1>

  <div id="alerts"></div>

  <button id="openModalBtn" class="btn btn-primary">Open modal</button>

  <!-- Modal -->
  <div class="modal fade" id="locationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="locationForm" class="modal-content" onsubmit="return false;">
        @csrf
        <div class="modal-header">
          <h5 class="modal-title">Select Country & States</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="country" class="form-label">Country</label>
            <select id="country" name="country_id" class="form-select" required>
              <option value="">-- Select country --</option>
              @foreach($countries as $country)
                <option value="{{ $country->id }}">{{ $country->name }}</option>
              @endforeach
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">States</label>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-muted">Tap checkboxes to select states</small>
              <div>
                <button id="selectAll" type="button" class="btn btn-sm btn-outline-secondary">Select all</button>
                <button id="clearAll"  type="button" class="btn btn-sm btn-outline-secondary">Clear</button>
              </div>
            </div>

            <div id="statesContainer" class="border rounded p-2" style="max-height:220px; overflow:auto;">
              <div class="text-muted">Select a country to load states.</div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button id="saveBtn" type="button" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
@endsection

@section('scripts')
<script>
document.addEventListener('DOMContentLoaded', function () {
  const openBtn = document.getElementById('openModalBtn');
  const countryEl = document.getElementById('country');
  const statesContainer = document.getElementById('statesContainer');
  const selectAllBtn = document.getElementById('selectAll');
  const clearAllBtn = document.getElementById('clearAll');
  const saveBtn = document.getElementById('saveBtn');
  const alerts = document.getElementById('alerts');

  const modalEl = document.getElementById('locationModal');
  const bsModal = new bootstrap.Modal(modalEl);

  function showAlert(html, type = 'success') {
    alerts.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
      ${html}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>`;
  }

  openBtn.addEventListener('click', () => {
    // clear alerts inside modal
    statesContainer.innerHTML = '<div class="text-muted">Select a country to load states.</div>';
    bsModal.show();
  });

  countryEl.addEventListener('change', async () => {
    const countryId = countryEl.value;
    statesContainer.innerHTML = '<div class="text-muted">Loading states…</div>';
    if (!countryId) {
      statesContainer.innerHTML = '<div class="text-muted">Select a country to load states.</div>';
      return;
    }

    try {
      const res = await fetch("{{ url('') }}/locations/states/" + encodeURIComponent(countryId), {
        headers: { 'Accept': 'application/json' }
      });
      if (!res.ok) throw new Error('Network response was not ok');

      const states = await res.json(); // array of {id, name}
      if (!states.length) {
        statesContainer.innerHTML = '<div class="text-muted">No states for this country.</div>';
        return;
      }

      // render checkboxes
      statesContainer.innerHTML = '';
      states.forEach(s => {
        const id = 'state_' + s.id;
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
          <input class="form-check-input" type="checkbox" value="${s.id}" id="${id}" name="state_ids[]">
          <label class="form-check-label" for="${id}">${escapeHtml(s.name)}</label>
        `;
        statesContainer.appendChild(div);
      });

    } catch (err) {
      console.error(err);
      statesContainer.innerHTML = '<div class="text-danger">Failed to load states — try again.</div>';
    }
  });

  selectAllBtn.addEventListener('click', () => {
    statesContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
  });
  clearAllBtn.addEventListener('click', () => {
    statesContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
  });

  saveBtn.addEventListener('click', async () => {
    const countryId = countryEl.value;
    const checked = Array.from(statesContainer.querySelectorAll('input[type="checkbox"]:checked'))
                         .map(cb => cb.value);

    if (!countryId) {
      showAlert('Please select a country.', 'danger'); return;
    }
    if (!checked.length) {
      showAlert('Please select at least one state.', 'danger'); return;
    }

    // Build form data including CSRF token
    const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '{{ csrf_token() }}';
    const formData = new FormData();
    formData.append('country_id', countryId);
    checked.forEach(id => formData.append('state_ids[]', id));
    formData.append('_token', token);

    try {
      const res = await fetch("{{ route('locations.save') }}", {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'application/json' }
      });

      if (res.status === 422) {
        const json = await res.json();
        const firstErr = Object.values(json.errors)[0][0];
        showAlert(firstErr, 'danger');
        return;
      }
      if (!res.ok) throw new Error('Network error');

      const json = await res.json();
      showAlert(json.message ?? 'Saved successfully.', 'success');
      bsModal.hide();
    } catch (err) {
      console.error(err);
      showAlert('Save failed — try again.', 'danger');
    }
  });

  function escapeHtml(str) {
    return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
  }
});
</script>
@endsection
```

---

# 4) Models & DB

* `countries` table: `id`, `name`, ...
* `states` table: `id`, `country_id`, `name`, ...
* `State` model should have `country()` belongsTo and `Country` model can have `states()` hasMany.

Example `State` model snippet:

```php
class State extends Model
{
    public function country()
    {
        return $this->belongsTo(Country::class);
    }
}
```

---

# 5) Notes & tips

* I used vanilla JS `fetch` returning JSON; this works with Laravel default CSRF token if you include the token (I used Blade `csrf_token()` fallback).
* If you prefer jQuery or Select2 for nicer multi-select UX, I can convert the client code.
* Adapt the controller `save()` to persist the selection to whichever model/table you need (user settings, pivot table, etc.). If you want, I can show `sync()` example for a `belongsToMany`.
* If states list is large, consider server-side search (AJAX endpoint that accepts a `q` query).

---

Want me to:

* Add `belongsToMany` save example with migrations and `sync()`?
* Show how to prefill the modal for editing previously-saved selections?
* Convert the checkboxes to a searchable list?









**********************************************************************************************************************
**********************************************************************************************************************
**********************************************************************************************************************

@extends('layouts.app')

@section('content')
<div class="container">
  <button id="openModalBtn" class="btn btn-primary">Choose Country & States</button>

  <!-- Bootstrap Modal -->
  <div class="modal fade" id="locationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="locationForm" action="{{ route('locations.save') }}" method="POST">
        @csrf
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Select Country & States</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="country" class="form-label">Country</label>
              <select id="country" name="country_id" class="form-select" required>
                <option value="">-- Select country --</option>
                @foreach($countries as $country)
                  <option value="{{ $country->id }}">{{ $country->name }}</option>
                @endforeach
              </select>
            </div>

            <div class="mb-3">
              <label for="states" class="form-label">States (select multiple)</label>
              <select id="states" name="state_ids[]" class="form-select" multiple="multiple" style="width:100%" required>
                <!-- options injected by JS -->
              </select>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
@endsection

@section('scripts')
<!-- include jQuery, Bootstrap JS and optionally Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(function() {
  // init select2 on states for multi-select UX
  $('#states').select2({
    placeholder: 'Select states',
    width: 'resolve' // keeps style from css above
  });

  // open modal on click
  $('#openModalBtn').on('click', function() {
    var modal = new bootstrap.Modal(document.getElementById('locationModal'));
    modal.show();
  });

  // when country changes, fetch states
  $('#country').on('change', function() {
    var countryId = $(this).val();
    $('#states').empty().trigger('change'); // clear current options
    if (!countryId) return;

    $.ajax({
      url: '{{ url('') }}/states/' + countryId, // or use route('locations.states', ...)
      type: 'GET',
      success: function(states) {
        // states expected as [{id, name}, ...]
        states.forEach(function(s) {
          var option = new Option(s.name, s.id, false, false);
          $('#states').append(option);
        });
        $('#states').trigger('change');
      },
      error: function() {
        alert('Failed to load states for the selected country.');
      }
    });
  });

  // Optional: if you want to preselect values, you can set them here
  // $('#country').val(1).trigger('change'); then set states after AJAX completes
});
</script>
@endsection






namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\Country;
use App\Models\State;

class LocationController extends Controller
{
    // Return JSON states for given country id
    public function states($countryId)
    {
        $states = State::where('country_id', $countryId)->select('id', 'name')->get();
        return response()->json($states);
    }

    // Save the selection
    public function saveSelection(Request $request)
    {
        $data = $request->validate([
            'country_id' => 'required|exists:countries,id',
            'state_ids'  => 'required|array',
            'state_ids.*'=> 'exists:states,id'
        ]);

        // Example: attach to user or save in DB
        // auth()->user()->update(['country_id' => $data['country_id']]);
        // sync states depending on your model

        return redirect()->back()->with('success', 'Selection saved.');
    }
}




use App\Http\Controllers\LocationController;

Route::get('/states/{country}', [LocationController::class, 'states'])->name('locations.states');
Route::post('/save-selection', [LocationController::class, 'saveSelection'])->name('locations.save');
