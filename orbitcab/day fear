

# Add days validation (frontend + backend)

Nice — below is a complete, practical patch that adds **day-based validation** so the form will block time-ranges that overlap **on any selected day**. I make two backend options depending on how you store days in `km_fares`:

* Preferred: `days` stored as a **JSON array** (MySQL `JSON` column). Example row: `["mon","tue"]`.
* Fallback: `days` stored as a **comma-separated string** (`mon,tue`) — I include that variant too.

---

## 1) Frontend changes (Blade / JS)

1. Send selected `days[]` in AJAX validation calls.
2. Ensure at least one day is selected before validating start/end.
3. Show errors if no days selected.

Replace the existing JS validation functions with this updated script (only changed parts shown where possible; you can replace the whole `<script>` content inside your `@push('scripts')` block):

```html
<script>
$(document).ready(function() {
    // ... keep previous top part (startValid/endValid, helpers) ...

    // Helper: get selected days as array (from checkboxes)
    function getSelectedDays() {
        const days = [];
        $('input[name="days[]"]:checked').each(function() {
            days.push($(this).val());
        });
        return days;
    }

    function validateStart() {
        const cat = $cat.val();
        const s = $start.val();
        const selectedDays = getSelectedDays();

        startValid = false;
        updateSubmitButton();
        $end.prop('disabled', true);

        if (!cat) {
            showError('Please select a vehicle category first.', $cat);
            return;
        }

        if (selectedDays.length === 0) {
            showError('Please select at least one day this fare applies to.', $('input[name="days[]"]').first());
            return;
        }

        if (!s) {
            showError('Please select a start time.', $start);
            return;
        }

        if (!/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(s)) {
            showError('Start time must be in HH:MM format (24-hour).', $start);
            return;
        }

        // AJAX: check if this exact start time already exists for ANY of the selected days
        $.ajax({
            url: baseUrl + 'ajax/validateStartTime',
            type: 'GET',
            data: {
                category: cat,
                start: s,
                days: selectedDays // send array (jQuery will expand to days[]=mon&days[]=tue)
            },
            dataType: 'json',
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            },
            success: function(res) {
                if (!res.valid) {
                    showError('This start time already belongs to an existing fare for one or more selected days.', $start);
                    $start.val('');
                } else {
                    $start.siblings('.time-range-error').remove();
                    startValid = true;
                    updateSubmitButton();
                    $end.prop('disabled', false).focus();
                }
            },
            error: function() {
                showError('Failed to check start time. Try again.', $start);
            }
        });
    }

    function validateEnd() {
        if (!startValid) return;

        const cat = $cat.val();
        const s = $start.val();
        const e = $end.val();
        const selectedDays = getSelectedDays();

        endValid = false;
        updateSubmitButton();

        if (selectedDays.length === 0) {
            showError('Please select at least one day this fare applies to.', $('input[name="days[]"]').first());
            return;
        }

        if (!e) {
            showError('Please select an end time.', $end);
            return;
        }

        if (!/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(e)) {
            showError('End time must be in HH:MM format (24-hour).', $end);
            return;
        }

        const sMins = timeToMins(s);
        const eMins = timeToMins(e);

        if (eMins <= sMins) {
            showError('End time must be later than start time.', $end);
            return;
        }

        // AJAX: check for overlap for any of the selected days
        $.ajax({
            url: baseUrl + 'ajax/validateTimeRange',
            type: 'GET',
            data: {
                category: cat,
                start: s,
                end: e,
                days: selectedDays
            },
            dataType: 'json',
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            },
            success: function(res) {
                if (!res.valid) {
                    showError('This time range overlaps with an existing fare on one or more selected days.', $end);
                    $end.val('');
                } else {
                    $end.siblings('.time-range-error').remove();
                    endValid = true;
                    updateSubmitButton();
                }
            },
            error: function() {
                showError('Failed to verify time range.', $end);
            }
        });
    }

    // Re-run validation when days checkboxes change (if start already present)
    $('input[name="days[]"]').on('change', function() {
        // reset validity and disable end until validated again
        startValid = endValid = false;
        $end.prop('disabled', true);
        updateSubmitButton();
        if ($start.val()) validateStart();
    });

    // keep your existing category change handler but ensure it doesn't remove days selection
    // existing bindings for $cat, $start, $end remain
    // ...
});
</script>
```

**Notes (frontend):**

* The JS sends `days` as an array, e.g. `days[]=mon&days[]=tue`.
* It also prevents validating if no day is selected and shows an inline error.
* I've added a handler to re-validate when days change.

---

## 2) Backend changes (Controller) — two variants

### A) Preferred: `days` column is JSON (MySQL `JSON`), e.g. `["mon","tue"]`

Add/replace `validateTimeRange` and `validateStartTime` with this code (Laravel):

```php
use Illuminate\Http\Request;
use App\Models\KmFare;

public function validateTimeRange(Request $request)
{
    $category = $request->category;
    $newStart = $request->start;
    $newEnd   = $request->end;
    $days = $request->input('days', []); // expect array

    if (empty($days) || !$category || !$newStart || !$newEnd) {
        return response()->json(['valid' => false]);
    }

    // Build query: find any km_fare for this category that shares ANY day in $days
    // and has a time overlap with [$newStart, $newEnd]
    $overlapQuery = KmFare::where('category_id', $category)
        ->where(function($q) use ($days) {
            foreach ($days as $day) {
                // whereJsonContains works with MySQL JSON columns
                $q->orWhereJsonContains('days', $day);
            }
        })
        ->where(function ($q) use ($newStart, $newEnd) {
            // overlap conditions — same as before
            $q->whereRaw('? BETWEEN start AND end', [$newStart])
                ->orWhereRaw('? BETWEEN start AND end', [$newEnd])
                ->orWhereRaw('start BETWEEN ? AND ?', [$newStart, $newEnd])
                ->orWhereRaw('end BETWEEN ? AND ?', [$newStart, $newEnd]);
        });

    $overlap = $overlapQuery->exists();

    return response()->json(['valid' => !$overlap]);
}

public function validateStartTime(Request $request)
{
    $category = $request->category;
    $newStart = $request->start;
    $days = $request->input('days', []);

    if (empty($days) || !$category || !$newStart) {
        return response()->json(['valid' => false]);
    }

    $overlapQuery = KmFare::where('category_id', $category)
        ->where(function($q) use ($days) {
            foreach ($days as $day) {
                $q->orWhereJsonContains('days', $day);
            }
        })
        ->where(function ($q) use ($newStart) {
            // Checking the newStart in existing ranges OR existing start equal to newStart
            $q->whereRaw('? BETWEEN start AND end', [$newStart])
              ->orWhere('start', $newStart);
        });

    $overlap = $overlapQuery->exists();

    return response()->json(['valid' => !$overlap]);
}
```

### B) Fallback: `days` stored as comma-separated string (e.g. `mon,tue`)

If your `days` column is stored as `mon,tue` (VARCHAR), use `FIND_IN_SET` or `LIKE`. This is less ideal, but works:

```php
public function validateTimeRange(Request $request)
{
    $category = $request->category;
    $newStart = $request->start;
    $newEnd   = $request->end;
    $days = $request->input('days', []);

    if (empty($days) || !$category || !$newStart || !$newEnd) {
        return response()->json(['valid' => false]);
    }

    $overlapQuery = KmFare::where('category_id', $category)
        ->where(function($q) use ($days) {
            foreach ($days as $day) {
                // FIND_IN_SET will check CSV stored days
                $q->orWhereRaw("FIND_IN_SET(?, days)", [$day]);
            }
        })
        ->where(function ($q) use ($newStart, $newEnd) {
            $q->whereRaw('? BETWEEN start AND end', [$newStart])
                ->orWhereRaw('? BETWEEN start AND end', [$newEnd])
                ->orWhereRaw('start BETWEEN ? AND ?', [$newStart, $newEnd])
                ->orWhereRaw('end BETWEEN ? AND ?', [$newStart, $newEnd]);
        });

    $overlap = $overlapQuery->exists();

    return response()->json(['valid' => !$overlap]);
}

public function validateStartTime(Request $request)
{
    $category = $request->category;
    $newStart = $request->start;
    $days = $request->input('days', []);

    if (empty($days) || !$category || !$newStart) {
        return response()->json(['valid' => false]);
    }

    $overlapQuery = KmFare::where('category_id', $category)
        ->where(function($q) use ($days) {
            foreach ($days as $day) {
                $q->orWhereRaw("FIND_IN_SET(?, days)", [$day]);
            }
        })
        ->where(function ($q) use ($newStart) {
            $q->whereRaw('? BETWEEN start AND end', [$newStart])
              ->orWhere('start', $newStart);
        });

    $overlap = $overlapQuery->exists();

    return response()->json(['valid' => !$overlap]);
}
```

**Important:** `FIND_IN_SET` works only for comma-separated strings without spaces. If values are stored like `mon, tue`, trim them or normalize before storing.

---

## 3) Optional: When saving new KmFare (server-side final check)

Even though client-side validation helps UX, always also check on server-side before inserting. Example (in `store` method):

```php
// gather inputs
$category = $request->category_id;
$start = $request->start;
$end = $request->end;
$days = $request->days; // array

// run the same overlap check as validateTimeRange (reuse logic in a private method)
if (! $this->isTimeRangeValidForDays($category, $start, $end, $days)) {
    return back()->withErrors(['time' => 'Selected time range overlaps existing fare for selected day(s).'])->withInput();
}

// then save
KmFare::create([
    'category_id' => $category,
    'start' => $start,
    'end' => $end,
    'days' => json_encode($days), // preferred
    // ... other fields
]);
```

And create a reusable function `isTimeRangeValidForDays()` to avoid duplication.

---

## 4) What else to check / recommended changes

* Ensure your `km_fares` table has a `days` column. If not, add one (prefer `json`):

  ```php
  $table->json('days')->nullable(); // migration
  ```
* Normalize days values (`mon,tue,wed`) and validate incoming days on the backend.
* If you use timezone-sensitive times, store times in a consistent format (you currently use HH:MM — OK if consistent).
* Add database index on `category_id` and consider indexes for JSON lookups if necessary (MySQL supports functional indexes on JSON keys in newer versions).
* Keep the server-side validation as authoritative (never trust client only).

---

If you want, I can:

* Patch your controller file with the JSON-based implementation (I can produce the full controller code).
* Provide a migration to add a `days` JSON column and an example seeder for `KmFare`.
* Add the server-side reusable `isTimeRangeValidForDays()` helper method and show how to call it from `store()`.

Tell me which one you'd like next and I’ll produce the code.





















@extends('layouts.app', ['isSidebar' => true, 'isNavbar' => true, 'isFooter' => false])
@push('styles')
    <link rel="stylesheet" href="{{ asset('assets/custom/css/style.css') }}">
@endpush
@section('content')
    <div class="container-xxl flex-grow-1 container-p-y">
        <div class="app-ecommerce">
            <!-- Add Product -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
                <div class="d-flex flex-column justify-content-center">
                    <h4 class="mb-1 mt-3">{{ __('Add Fare') }}</h4>
                </div>
                <div class="d-flex align-content-center flex-wrap gap-3">
                    <x-site.back />
                </div>
            </div>
            <div class="row">
                <!-- First column-->
                <div class="col-12">
                    <!-- User Information -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="form_header">
                                <h5 class="card-tile mb-3">{{ __('Fare Information') }}</h5>
                            </div>
                            <form method="post" class="arrayFormSubmit" id="addFareForm"
                                action="{{ route('admin.fares.day.add') }}">
                                @csrf

                                <div class="add_form">
                                    <div class="row  rounded-2 p-2">
                                        <div class="col-md-6">
                                            <label for="category_id">Vehicle Category<span
                                                    class="text-rose-500">*</span></label>
                                            <select name="category_id" id="category_id" required
                                                class="form-control @error('category_id') is-invalid @enderror">
                                                <option>Select Vehicle Category</option>
                                                {{ getCategoryTypeSubType('') }}
                                            </select>
                                        </div>
                                        <div class="col-md-6 fare_type fare-type">
                                            <label for="">Fare Type<span class="text-rose-500">*</span></label>
                                            <div class="d-flex col-md-12 p-2 fare_type">
                                                <div class="skin skin-square mx-1">
                                                    <input type="radio" value="non-ac" name="fare_for[]"
                                                        id="check_inline_non_ac">
                                                    <label for="check_inline_non_ac">Non Ac</label>
                                                </div>
                                                <div class="skin skin-square mx-1">
                                                    <input type="radio" value="ac" name="fare_for[]"
                                                        id="check_inline_ac">
                                                    <label for="check_inline_ac">Ac</label>
                                                </div>
                                                <div class="skin skin-square mx-1">
                                                    <input type="radio" value="both" name="fare_for[]"
                                                        id="check_inline_both">
                                                    <label for="check_inline_both">Both</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-12 mb-2 mt-3">
                                            <div class="row">
                                                <!-- Days of Week -->
                                                <div class="mb-4">
                                                    <label class="form-label">Applicable Days <span
                                                            class="text-danger">*</span></label>
                                                    <div class="row g-2">
                                                        @php
                                                            $weekDays = [
                                                                'mon' => 'Mon',
                                                                'tue' => 'Tue',
                                                                'wed' => 'Wed',
                                                                'thu' => 'Thu',
                                                                'fri' => 'Fri',
                                                                'sat' => 'Sat',
                                                                 'sun' => 'Sun',
                                                            ];
                                                        @endphp
                                                        @foreach ($weekDays as $value => $label)
                                                            <div class="col-6 col-sm-4 col-md-3 col-lg-auto day-checkbox">
                                                                <div class="form-check">
                                                                    <input class="form-check-input" type="checkbox"
                                                                        name="days[]" id="day_{{ $value }}"
                                                                        value="{{ $value }}">
                                                                    <label class="form-check-label fw-bold"
                                                                        for="day_{{ $value }}">{{ $label }}</label>
                                                                </div>
                                                            </div>
                                                        @endforeach
                                                    </div>
                                                    <small class="text-muted">Select days this fare applies to</small>
                                                </div>
                                                {{-- <div class="col-md-8">
                                                    <div class="row">
                                                        @php
                                                            $weekDays = [
                                                                'sun' => 'Sun',
                                                                'mon' => 'Mon',
                                                                'tue' => 'Tue',
                                                                'wed' => 'Wed',
                                                                'thu' => 'Thu',
                                                                'fri' => 'Fri',
                                                                'sat' => 'Sat',
                                                            ];
                                                        @endphp

                                                        @foreach ($weekDays as $value => $label)
                                                            <div class="col-md-1">
                                                                <input type="checkbox" class="form-check-input"
                                                                    name="days[]" id="day_{{ $value }}"
                                                                    value="{{ $value }}"
                                                                    style="transform: scale(1.5);">
                                                                <label class="form-check-label fw-bold mt-2 d-block"
                                                                    for="day_{{ $value }}">
                                                                    {{ $label }}
                                                                </label>
                                                            </div>
                                                        @endforeach

                                                    </div>
                                                </div> --}}
                                                <div class="col-md-8 mt-2">
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <label for="start">Start At<span
                                                                    class="text-rose-500">*</span></label>
                                                            <input type="time" class="form-control time-range" required
                                                                name="start" id="start" value="00:00">
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label for="end">End At<span
                                                                    class="text-rose-500">*</span></label>
                                                            <input type="time" class="form-control time-range" required
                                                                name="end" id="end" value="23:59">
                                                        </div>


                                                        <div class="col-md-4 mb-2">
                                                            <label for="base_fare">Base Fare<span
                                                                    class="text-rose-500">*</span></label>
                                                            <input type="text" class="form-control number-only" required
                                                                step=".01" min="0" name="base_fare"
                                                                id="base_fare">
                                                        </div>
                                                        <div class="col-md-4 mb-2">
                                                            <label for="rate_per_km">Per KM Fare<span
                                                                    class="text-rose-500">*</span></label>
                                                            <input type="text" class="form-control number-only" required
                                                                step=".01" name="rate_per_km" id="rate_per_km">
                                                        </div>
                                                        <div class="col-md-4 mb-2">
                                                            <label for="time_charge">Time/Charge (Rs./Minute)<span
                                                                    class="text-rose-500">*</span></label>
                                                            {{-- <span class="input-group-text contact_input_txt">{{ getCurrency() }}</span> --}}
                                                            <input type="text" class="form-control number-only"
                                                                required step=".01" name="rate_per_minute"
                                                                id="rate_per_minute">
                                                        </div>
                                                        <div class="col-md-4 mb-2">
                                                            <label for="waiting_charge">Waiting Charge (Rs./Minute)<span
                                                                    class="text-rose-500">*</span></label>
                                                            {{-- <span class="input-group-text contact_input_txt">{{ getCurrency() }}</span> --}}
                                                            <input type="text" class="form-control number-only"
                                                                required step=".01" name="waiting_charge"
                                                                id="waiting_charge">
                                                        </div>
                                                        <div class="col-md-4 mb-2">
                                                            <label for="toll_mcd">Toll + MCD<span
                                                                    class="text-rose-500">*</span></label>
                                                            {{-- <span class="input-group-text contact_input_txt">{{ getCurrency() }}</span> --}}
                                                            <input type="text" class="form-control number-only"
                                                                required step=".01" name="toll_mcd_charge"
                                                                id="toll_mcd">
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-md-4">
                                                    <label class="form-label">Existing Time Ranges</label>
                                                    <div class="fare-preview km_fare_time p-3">
                                                        <p class="text-muted small">Select category to view existing fares
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <br>
                                        <div class="button_right ">
                                            <button type="submit" class="btn btn-primary">{{ __('Save') }}</button>
                                        </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
@endsection

@push('scripts')
    <script src="{{ asset('assets/custom/js/zone.js') }}"></script>
    <script>
        $(document).ready(function() {
            // Global flags
            let startValid = false;
            let endValid = false;
            const $start = $('#start');
            const $end = $('#end');
            const $cat = $('#category_id');
            const $submit = $('#addFareForm button[type="submit"]');

            // Helper: convert HH:MM → minutes
            function timeToMins(t) {
                const [h, m] = t.split(':').map(Number);
                return h * 60 + m;
            }

            // Helper: show error under a specific field
            function showError(msg, $field) {
                // Remove any previous error under this field
                $field.siblings('.time-range-error').remove();
                const $err = $('<div class="time-range-error text-danger mt-1"></div>').text(msg);
                $err.insertAfter($field);
                setTimeout(() => $err.fadeOut('slow', () => $err.remove()), 4000);
            }

            // Enable/disable submit
            function updateSubmitButton() {
                $submit.prop('disabled', !(startValid && endValid));
            }

            // -------------------------------------------------------------
            // 1. VALIDATE START TIME (runs first)
            // -------------------------------------------------------------
            function validateStart() {
                const cat = $cat.val();
                const s = $start.val();

                startValid = false;
                updateSubmitButton();
                $end.prop('disabled', true); // block end until start is valid

                if (!cat) {
                    showError('Please select a vehicle category first.', $cat);
                    return;
                }

                if (!s) {
                    showError('Please select a start time.', $start);
                    return;
                }

                if (!/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(s)) {
                    showError('Start time must be in HH:MM format (24-hour).', $start);
                    return;
                }

                // AJAX: check if this exact start time already exists
                $.ajax({
                    url: baseUrl + 'ajax/validateStartTime',
                    type: 'GET',
                    data: {
                        category: cat,
                        start: s
                    },
                    dataType: 'json',
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    },
                    success: function(res) {
                        if (!res.valid) {
                            showError('This start time already belongs to an existing fare.', $start);
                            $start.val('');
                        } else {
                            $start.siblings('.time-range-error').remove();
                            startValid = true;
                            updateSubmitButton();
                            $end.prop('disabled', false).focus(); // allow end input
                        }
                    },
                    error: function() {
                        showError('Failed to check start time. Try again.', $start);
                    }
                });
            }

            // -------------------------------------------------------------
            // 2. VALIDATE END TIME (only if start is valid)
            // -------------------------------------------------------------
            function validateEnd() {
                if (!startValid) return;

                const cat = $cat.val();
                const s = $start.val();
                const e = $end.val();

                endValid = false;
                updateSubmitButton();

                if (!e) {
                    showError('Please select an end time.', $end);
                    return;
                }

                if (!/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(e)) {
                    showError('End time must be in HH:MM format (24-hour).', $end);
                    return;
                }

                const sMins = timeToMins(s);
                const eMins = timeToMins(e);

                if (eMins <= sMins) {
                    showError('End time must be later than start time.', $end);
                    return;
                }

                // AJAX: check for overlap
                $.ajax({
                    url: baseUrl + 'ajax/validateTimeRange',
                    type: 'GET',
                    data: {
                        category: cat,
                        start: s,
                        end: e
                    },
                    dataType: 'json',
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    },
                    success: function(res) {
                        if (!res.valid) {
                            showError('This time range overlaps with an existing fare.', $end);
                            $end.val('');
                        } else {
                            $end.siblings('.time-range-error').remove();
                            endValid = true;
                            updateSubmitButton();
                        }
                    },
                    error: function() {
                        showError('Failed to verify time range.', $end);
                    }
                });
            }

            // -------------------------------------------------------------
            // 3. EVENT LISTENERS
            // -------------------------------------------------------------
            $cat.on('change', function() {
                startValid = endValid = false;
                $start.val('00:00').siblings('.time-range-error').remove();
                $end.val('23:59').prop('disabled', true).siblings('.time-range-error').remove();
                updateSubmitButton();
                if ($start.val()) validateStart();
            });

            $start.on('change', validateStart);
            $end.on('change', validateEnd);

            // -------------------------------------------------------------
            // 4. FORM SUBMIT PROTECTION
            // -------------------------------------------------------------
            // $('#addFareForm').on('submit', function(e) {
            //     if (!startValid || !endValid) {
            //         e.preventDefault();
            //         showError('Please fix time errors before saving.', $end);
            //         return false;
            //     }
            // });

            // -------------------------------------------------------------
            // 5. YOUR EXISTING CATEGORY AJAX (unchanged)
            // -------------------------------------------------------------
            $('.fare-type').hide();
            $('#category_id').on('change', function(e) {
                e.preventDefault();
                let category = $(this).val();
                $.ajax({
                    type: "GET",
                    url: baseUrl + 'ajax/getCategoryType',
                    data: {
                        'category': category
                    },
                    dataType: "json",
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    },
                    success: function(response) {
                        $('.km_fare_time').empty();
                        if (response.km_fare && response.km_fare.length > 0) {
                            response.km_fare.forEach(fare => {
                                $('.km_fare_time').append(
                                    `<div class="fare-info p-2 border rounded mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold">Time Range:</span>
                                        <span>${fare.start} - ${fare.end}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold">Base Fare:</span>
                                        <span>${fare.base_fare}</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-bold">Rate/Km:</span>
                                        <span>${fare.rate_per_km}</span>
                                    </div>
                                </div>`
                                );
                            });
                        }
                        $('.fare_type').toggle(response.slug === 'four_wheeler');
                    },
                    error: function(xhr, status, error) {
                        console.error("Error occurred: " + error);
                    }
                });
            });

            // Initial state
            $end.prop('disabled', true);
            updateSubmitButton();
        });
    </script>
@endpush


  public function getCategoryType(Request $request)
    {
        if ($request->ajax()) {
            // dd($request->all());
            try {
                // $id = uuidtoid($request->category, 'categories');
                $totalData = $this->categoryService->findCategoryById($request->category);
                $vehicleType = Category::where('id', $totalData->parent_id)->first();
                $kmFare = KmFare::where('category_id', $totalData->id)->get();
                $vehicleType->km_fare = $kmFare;
                // dd($vehicleType);
                return $vehicleType;
            } catch (\Exception $e) {
                logger($e->getMessage() . ' on ' . $e->getFile() . ' line number ' . $e->getLine());
                return $jsonData = array(
                    "draw" => (int) $request->input('draw'),
                    "recordsTotal" => (int) 0,
                    "recordsFiltered" => (int) 0,
                    "data" => []
                );
            }
        }
    }


  public function validateTimeRange(Request $request)
    {
        $newStart = $request->start;
        $newEnd   = $request->end;

        $overlap = KmFare::where('category_id', $request->category)
            ->where(function ($q) use ($newStart, $newEnd) {
                $q->whereRaw('? BETWEEN start AND end', [$newStart])
                    ->orWhereRaw('? BETWEEN start AND end', [$newEnd])
                    ->orWhereRaw('start BETWEEN ? AND ?', [$newStart, $newEnd])
                    ->orWhereRaw('end BETWEEN ? AND ?', [$newStart, $newEnd]);
            })->exists();

        return response()->json(['valid' => !$overlap]);
    }

  public function validateStartTime(Request $request)
    {
        $newStart = $request->start;
        $newEnd   = $request->end;

        $overlap = KmFare::where('category_id', $request->category)
            ->where(function ($q) use ($newStart, $newEnd) {
                $q->whereRaw('? BETWEEN start AND end', [$newStart])
                    ->orWhereRaw('? BETWEEN start AND end', [$newEnd])
                    ->orWhereRaw('start BETWEEN ? AND ?', [$newStart, $newEnd])
                    ->orWhereRaw('end BETWEEN ? AND ?', [$newStart, $newEnd]);
            })->exists();

        return response()->json(['valid' => !$overlap]);
    }


      
